# å®æˆ˜é¡¹ç›®ä¸‰ï¼šå®‰å…¨ä»£ç æ‰§è¡Œå¹³å°

æœ¬æ–‡å°†æ„å»ºä¸€ä¸ªå®‰å…¨çš„ä»£ç æ‰§è¡Œå¹³å°ï¼Œæ”¯æŒå¤šè¯­è¨€ä»£ç è¿è¡Œã€æ‰§è¡Œç»“æœå¯è§†åŒ–å’Œå±é™©æ“ä½œå®¡æ‰¹ã€‚è¿™ä¸ªé¡¹ç›®ç»¼åˆè¿ç”¨äº†æ²™ç®±ç³»ç»Ÿã€äººæœºåä½œå’Œæµå¼è¾“å‡ºç­‰æ ¸å¿ƒèƒ½åŠ›ã€‚

## é¡¹ç›®æ¦‚è¿°

å®‰å…¨ä»£ç æ‰§è¡Œå¹³å°å…·å¤‡ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

- **å¤šè¯­è¨€ä»£ç æ‰§è¡Œ**ï¼šæ”¯æŒ Pythonã€JavaScriptã€Go ç­‰å¤šç§è¯­è¨€
- **æ²™ç®±éš”ç¦»**ï¼šæ‰€æœ‰ä»£ç åœ¨éš”ç¦»ç¯å¢ƒä¸­æ‰§è¡Œï¼Œä¿æŠ¤å®¿ä¸»ç³»ç»Ÿ
- **æ‰§è¡Œç»“æœå¯è§†åŒ–**ï¼šå®æ—¶æ˜¾ç¤ºæ‰§è¡Œè¾“å‡ºå’Œèµ„æºä½¿ç”¨
- **å±é™©æ“ä½œå®¡æ‰¹**ï¼šæ•æ„Ÿæ“ä½œéœ€è¦äººå·¥ç¡®è®¤
- **æ‰§è¡Œå†å²è®°å½•**ï¼šè®°å½•æ‰€æœ‰æ‰§è¡Œå†å²ï¼Œæ”¯æŒå›æº¯

## æŠ€æœ¯æ¶æ„

```
å®‰å…¨ä»£ç æ‰§è¡Œå¹³å°
â”œâ”€â”€ ä¸»ä»£ç† (ExecutionManager)
â”‚   â”œâ”€â”€ è¯·æ±‚è§£æ
â”‚   â”œâ”€â”€ å®‰å…¨æ£€æŸ¥
â”‚   â””â”€â”€ ç»“æœæ ¼å¼åŒ–
â”œâ”€â”€ æ²™ç®±åç«¯
â”‚   â”œâ”€â”€ Modal æ²™ç®±
â”‚   â”œâ”€â”€ Daytona æ²™ç®±
â”‚   â””â”€â”€ æœ¬åœ° Docker æ²™ç®±
â”œâ”€â”€ äººæœºåä½œ
â”‚   â”œâ”€â”€ ä»£ç å®¡æŸ¥
â”‚   â””â”€â”€ æ‰§è¡Œå®¡æ‰¹
â””â”€â”€ ç›‘æ§ç³»ç»Ÿ
    â”œâ”€â”€ èµ„æºç›‘æ§
    â””â”€â”€ æ‰§è¡Œæ—¥å¿—
```

## é¡¹ç›®åˆå§‹åŒ–

### ç›®å½•ç»“æ„

```
code-executor/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ agents/
â”‚   â”‚   â””â”€â”€ executor-agent.ts
â”‚   â”œâ”€â”€ backends/
â”‚   â”‚   â””â”€â”€ sandbox-backend.ts
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â””â”€â”€ execution-tools.ts
â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â””â”€â”€ code-analyzer.ts
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

### å®‰è£…ä¾èµ–

```bash
npm init -y
npm install @langchain/langgraph-agents @langchain/anthropic zod
npm install -D typescript @types/node
```

## æ²™ç®±åç«¯é…ç½®

### Modal æ²™ç®±é…ç½®

```typescript
// src/backends/sandbox-backend.ts
import { ModalSandbox } from "@langchain/langgraph-agents/sandbox";
import { CompositeBackend, StateBackend } from "@langchain/langgraph-agents/backends";

export function createModalSandboxBackend() {
  return (rt: any) => {
    const sandbox = new ModalSandbox({
      image: "python:3.11",
      timeout: 300,
      memory: 512,
      cpu: 1,
    });

    return new CompositeBackend(
      sandbox,
      {
        "/logs/": new StateBackend(rt),
        "/results/": new StateBackend(rt),
      }
    );
  };
}
```

### Daytona æ²™ç®±é…ç½®

```typescript
import { DaytonaSandbox } from "@langchain/langgraph-agents/sandbox";

export function createDaytonaSandboxBackend() {
  return (rt: any) => {
    const sandbox = new DaytonaSandbox({
      workspace: "code-executor",
      persistWorkspace: false,
    });

    return new CompositeBackend(
      sandbox,
      {
        "/logs/": new StateBackend(rt),
        "/results/": new StateBackend(rt),
      }
    );
  };
}
```

### å¤šæ²™ç®±é€‰æ‹©

```typescript
type SandboxType = "modal" | "daytona" | "local";

export function createSandboxBackend(type: SandboxType) {
  switch (type) {
    case "modal":
      return createModalSandboxBackend();
    case "daytona":
      return createDaytonaSandboxBackend();
    case "local":
      return createLocalDockerBackend();
    default:
      throw new Error(`æœªçŸ¥çš„æ²™ç®±ç±»å‹: ${type}`);
  }
}
```

## ä»£ç å®‰å…¨åˆ†æ

```typescript
// src/security/code-analyzer.ts
interface SecurityAnalysis {
  safe: boolean;
  riskLevel: "low" | "medium" | "high" | "critical";
  warnings: string[];
  blockedPatterns: string[];
}

const DANGEROUS_PATTERNS = [
  { pattern: /rm\s+-rf/i, risk: "critical", desc: "å±é™©çš„åˆ é™¤å‘½ä»¤" },
  { pattern: /eval\s*\(/i, risk: "high", desc: "åŠ¨æ€ä»£ç æ‰§è¡Œ" },
  { pattern: /exec\s*\(/i, risk: "high", desc: "å‘½ä»¤æ‰§è¡Œ" },
  { pattern: /subprocess/i, risk: "medium", desc: "å­è¿›ç¨‹è°ƒç”¨" },
  { pattern: /os\.system/i, risk: "high", desc: "ç³»ç»Ÿå‘½ä»¤æ‰§è¡Œ" },
  { pattern: /import\s+socket/i, risk: "medium", desc: "ç½‘ç»œè®¿é—®" },
  { pattern: /open\s*\([^)]*['"]\/etc/i, risk: "high", desc: "ç³»ç»Ÿæ–‡ä»¶è®¿é—®" },
  { pattern: /curl|wget/i, risk: "medium", desc: "ç½‘ç»œä¸‹è½½" },
];

export function analyzeCodeSecurity(code: string): SecurityAnalysis {
  const warnings: string[] = [];
  const blockedPatterns: string[] = [];
  let maxRisk: SecurityAnalysis["riskLevel"] = "low";

  for (const { pattern, risk, desc } of DANGEROUS_PATTERNS) {
    if (pattern.test(code)) {
      warnings.push(`${desc} (é£é™©: ${risk})`);

      if (risk === "critical") {
        blockedPatterns.push(desc);
        maxRisk = "critical";
      } else if (risk === "high" && maxRisk !== "critical") {
        maxRisk = "high";
      } else if (risk === "medium" && maxRisk === "low") {
        maxRisk = "medium";
      }
    }
  }

  return {
    safe: blockedPatterns.length === 0,
    riskLevel: maxRisk,
    warnings,
    blockedPatterns,
  };
}
```

## æ‰§è¡Œå·¥å…·

```typescript
// src/tools/execution-tools.ts
import { tool } from "@langchain/core/tools";
import { z } from "zod";
import { analyzeCodeSecurity } from "../security/code-analyzer";

export const analyzeCodeTool = tool(
  async ({ code, language }) => {
    const analysis = analyzeCodeSecurity(code);

    return JSON.stringify({
      language,
      codeLength: code.length,
      lineCount: code.split("\n").length,
      ...analysis,
    }, null, 2);
  },
  {
    name: "analyze_code",
    description: "åˆ†æä»£ç çš„å®‰å…¨æ€§",
    schema: z.object({
      code: z.string().describe("è¦åˆ†æçš„ä»£ç "),
      language: z.string().describe("ç¼–ç¨‹è¯­è¨€"),
    }),
  }
);

export const formatResultTool = tool(
  async ({ stdout, stderr, exitCode, executionTime }) => {
    const status = exitCode === 0 ? "âœ… æˆåŠŸ" : "âŒ å¤±è´¥";

    let output = `## æ‰§è¡Œç»“æœ ${status}\n\n`;
    output += `**é€€å‡ºç **: ${exitCode}\n`;
    output += `**æ‰§è¡Œæ—¶é—´**: ${executionTime}ms\n\n`;

    if (stdout) {
      output += `### æ ‡å‡†è¾“å‡º\n\`\`\`\n${stdout}\n\`\`\`\n\n`;
    }

    if (stderr) {
      output += `### é”™è¯¯è¾“å‡º\n\`\`\`\n${stderr}\n\`\`\`\n\n`;
    }

    return output;
  },
  {
    name: "format_result",
    description: "æ ¼å¼åŒ–æ‰§è¡Œç»“æœ",
    schema: z.object({
      stdout: z.string().describe("æ ‡å‡†è¾“å‡º"),
      stderr: z.string().describe("é”™è¯¯è¾“å‡º"),
      exitCode: z.number().describe("é€€å‡ºç "),
      executionTime: z.number().describe("æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰"),
    }),
  }
);

export const saveExecutionLogTool = tool(
  async ({ code, language, result, timestamp }) => {
    const filename = `/logs/${timestamp}-${language}.json`;

    const log = {
      timestamp,
      language,
      code,
      result,
      savedAt: new Date().toISOString(),
    };

    return { filename, content: JSON.stringify(log, null, 2) };
  },
  {
    name: "save_execution_log",
    description: "ä¿å­˜æ‰§è¡Œæ—¥å¿—",
    schema: z.object({
      code: z.string(),
      language: z.string(),
      result: z.any(),
      timestamp: z.string(),
    }),
  }
);
```

## ä¸»ä»£ç†é…ç½®

```typescript
// src/agents/executor-agent.ts
import { createDeepAgent } from "@langchain/langgraph-agents";
import { createSandboxBackend } from "../backends/sandbox-backend";
import { analyzeCodeTool, formatResultTool, saveExecutionLogTool } from "../tools/execution-tools";

export function createCodeExecutor(sandboxType: "modal" | "daytona" | "local" = "modal") {
  return createDeepAgent({
    model: "claude-sonnet-4-20250514",
    name: "code-executor",
    systemPrompt: `ä½ æ˜¯ä¸€ä¸ªå®‰å…¨çš„ä»£ç æ‰§è¡Œå¹³å°ã€‚ä½ çš„èŒè´£æ˜¯ï¼š

1. æ¥æ”¶ç”¨æˆ·çš„ä»£ç æ‰§è¡Œè¯·æ±‚
2. åˆ†æä»£ç çš„å®‰å…¨æ€§
3. åœ¨æ²™ç®±ç¯å¢ƒä¸­æ‰§è¡Œä»£ç 
4. è¿”å›æ ¼å¼åŒ–çš„æ‰§è¡Œç»“æœ

å®‰å…¨ç­–ç•¥ï¼š
- æ‰€æœ‰ä»£ç éƒ½åœ¨éš”ç¦»çš„æ²™ç®±ä¸­æ‰§è¡Œ
- é«˜é£é™©æ“ä½œéœ€è¦äººå·¥å®¡æ‰¹
- ç¦æ­¢æ‰§è¡Œå±é™©çš„ç³»ç»Ÿå‘½ä»¤
- é™åˆ¶ç½‘ç»œè®¿é—®å’Œèµ„æºä½¿ç”¨

æ”¯æŒçš„è¯­è¨€ï¼š
- Python (python3)
- JavaScript (node)
- Go (go run)
- Bash (bash)

æ‰§è¡Œæµç¨‹ï¼š
1. ä½¿ç”¨ analyze_code æ£€æŸ¥ä»£ç å®‰å…¨æ€§
2. å¦‚æœå®‰å…¨ï¼Œä½¿ç”¨ execute æ‰§è¡Œä»£ç 
3. ä½¿ç”¨ format_result æ ¼å¼åŒ–è¾“å‡º
4. ä½¿ç”¨ save_execution_log è®°å½•æ—¥å¿—`,
    tools: [analyzeCodeTool, formatResultTool, saveExecutionLogTool],
    backend: createSandboxBackend(sandboxType),
    interruptOn: {
      execute: {
        condition: (args: any) => {
          const analysis = analyzeCodeSecurity(args.command || "");
          return analysis.riskLevel === "high" || analysis.riskLevel === "critical";
        },
      },
    },
  });
}
```

## äººæœºåä½œï¼šæ‰§è¡Œå®¡æ‰¹

```typescript
// src/approval/execution-approval.ts
import { HumanMessage, AIMessage } from "@langchain/core/messages";

interface ApprovalRequest {
  code: string;
  language: string;
  riskLevel: string;
  warnings: string[];
}

interface ApprovalResponse {
  approved: boolean;
  modifiedCode?: string;
  reason?: string;
}

export async function requestExecutionApproval(
  agent: any,
  request: ApprovalRequest
): Promise<ApprovalResponse> {
  console.log("\nâš ï¸  éœ€è¦äººå·¥å®¡æ‰¹");
  console.log("================");
  console.log(`è¯­è¨€: ${request.language}`);
  console.log(`é£é™©ç­‰çº§: ${request.riskLevel}`);
  console.log(`è­¦å‘Š:\n${request.warnings.map((w) => `  - ${w}`).join("\n")}`);
  console.log("\nä»£ç :");
  console.log("```");
  console.log(request.code);
  console.log("```\n");

  const readline = await import("readline");
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  return new Promise((resolve) => {
    rl.question("æ‰¹å‡†æ‰§è¡Œ? (y/n/e[edit]): ", async (answer) => {
      rl.close();

      switch (answer.toLowerCase()) {
        case "y":
        case "yes":
          resolve({ approved: true });
          break;
        case "e":
        case "edit":
          const modifiedCode = await editCode(request.code);
          resolve({ approved: true, modifiedCode });
          break;
        default:
          resolve({ approved: false, reason: "ç”¨æˆ·æ‹’ç»æ‰§è¡Œ" });
      }
    });
  });
}

async function editCode(originalCode: string): Promise<string> {
  console.log("\nè¯·è¾“å…¥ä¿®æ”¹åçš„ä»£ç ï¼ˆè¾“å…¥ END ç»“æŸï¼‰:");

  const readline = await import("readline");
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  const lines: string[] = [];

  return new Promise((resolve) => {
    rl.on("line", (line) => {
      if (line === "END") {
        rl.close();
        resolve(lines.join("\n"));
      } else {
        lines.push(line);
      }
    });
  });
}
```

## ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä»£ç æ‰§è¡Œ

```typescript
// src/index.ts
import { createCodeExecutor } from "./agents/executor-agent";

async function executeCode() {
  const agent = createCodeExecutor("modal");

  const result = await agent.invoke({
    messages: [
      {
        role: "human",
        content: `
è¯·æ‰§è¡Œä»¥ä¸‹ Python ä»£ç ï¼š

\`\`\`python
import math

def calculate_primes(n):
    primes = []
    for num in range(2, n + 1):
        is_prime = True
        for i in range(2, int(math.sqrt(num)) + 1):
            if num % i == 0:
                is_prime = False
                break
        if is_prime:
            primes.append(num)
    return primes

result = calculate_primes(100)
print(f"å‰100ä¸ªè‡ªç„¶æ•°ä¸­çš„è´¨æ•°: {result}")
print(f"å…± {len(result)} ä¸ªè´¨æ•°")
\`\`\`
`,
      },
    ],
  });

  console.log(result.messages.at(-1)?.content);
}

executeCode();
```

### å¤šè¯­è¨€æ‰§è¡Œ

```typescript
async function multiLanguageExecution() {
  const agent = createCodeExecutor("daytona");

  const codes = [
    {
      language: "python",
      code: `print("Hello from Python!")`,
    },
    {
      language: "javascript",
      code: `console.log("Hello from JavaScript!");`,
    },
    {
      language: "go",
      code: `
package main
import "fmt"
func main() {
    fmt.Println("Hello from Go!")
}`,
    },
  ];

  for (const { language, code } of codes) {
    const result = await agent.invoke({
      messages: [
        {
          role: "human",
          content: `æ‰§è¡Œä»¥ä¸‹ ${language} ä»£ç ï¼š\n\`\`\`${language}\n${code}\n\`\`\``,
        },
      ],
    });

    console.log(`\n=== ${language.toUpperCase()} ===`);
    console.log(result.messages.at(-1)?.content);
  }
}
```

### å±é™©ä»£ç æ‹¦æˆª

```typescript
async function dangerousCodeDemo() {
  const agent = createCodeExecutor("modal");

  const result = await agent.invoke({
    messages: [
      {
        role: "human",
        content: `
æ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š

\`\`\`python
import os
os.system("rm -rf /tmp/*")  # è¿™åº”è¯¥è¢«æ‹¦æˆª
\`\`\`
`,
      },
    ],
  });

  console.log(result.messages.at(-1)?.content);
}
```

## æµå¼è¾“å‡ºï¼šå®æ—¶æ‰§è¡Œè¿›åº¦

```typescript
async function streamingExecution() {
  const agent = createCodeExecutor("modal");

  const messages = [
    {
      role: "human",
      content: `
æ‰§è¡Œä¸€ä¸ªè€—æ—¶çš„ Python è„šæœ¬ï¼š

\`\`\`python
import time

for i in range(5):
    print(f"Step {i + 1}/5")
    time.sleep(1)

print("å®Œæˆ!")
\`\`\`
`,
    },
  ];

  console.log("ğŸš€ å¼€å§‹æ‰§è¡Œ...\n");

  for await (const [namespace, chunk] of await agent.stream(
    { messages },
    { streamMode: ["updates", "messages", "custom"], subgraphs: true }
  )) {
    if (chunk.type === "AIMessageChunk" && chunk.content) {
      process.stdout.write(chunk.content);
    }

    if (chunk.type === "tool_result") {
      console.log(`\nğŸ“‹ å·¥å…·ç»“æœ: ${chunk.toolName}`);
    }

    if (chunk.type === "execution_output") {
      console.log(`\nğŸ“¤ è¾“å‡º: ${chunk.output}`);
    }
  }

  console.log("\n\nâœ… æ‰§è¡Œå®Œæˆ");
}
```

## å‰ç«¯é›†æˆ

```tsx
import { useStream } from "@langchain/langgraph-sdk/react";
import { useState } from "react";
import Editor from "@monaco-editor/react";

function CodeExecutor() {
  const [code, setCode] = useState("");
  const [language, setLanguage] = useState("python");

  const stream = useStream({
    assistantId: "code-executor",
    apiUrl: "http://localhost:2024",
  });

  const executeCode = async () => {
    await stream.submit({
      messages: [
        {
          role: "human",
          content: `æ‰§è¡Œä»¥ä¸‹ ${language} ä»£ç ï¼š\n\`\`\`${language}\n${code}\n\`\`\``,
        },
      ],
    });
  };

  const handleApproval = async (approved: boolean) => {
    if (stream.isInterrupted) {
      await stream.resume({ action: approved ? "approve" : "reject" });
    }
  };

  return (
    <div className="code-executor">
      <div className="editor-section">
        <div className="toolbar">
          <select value={language} onChange={(e) => setLanguage(e.target.value)}>
            <option value="python">Python</option>
            <option value="javascript">JavaScript</option>
            <option value="go">Go</option>
            <option value="bash">Bash</option>
          </select>
          <button onClick={executeCode} disabled={stream.isLoading}>
            â–¶ è¿è¡Œ
          </button>
        </div>
        <Editor
          height="300px"
          language={language}
          value={code}
          onChange={(value) => setCode(value || "")}
          theme="vs-dark"
        />
      </div>

      {stream.isInterrupted && (
        <div className="approval-dialog">
          <h3>âš ï¸ éœ€è¦å®¡æ‰¹</h3>
          <p>æ£€æµ‹åˆ°æ½œåœ¨å±é™©æ“ä½œï¼Œæ˜¯å¦ç»§ç»­æ‰§è¡Œï¼Ÿ</p>
          <div className="actions">
            <button onClick={() => handleApproval(true)}>âœ… æ‰¹å‡†</button>
            <button onClick={() => handleApproval(false)}>âŒ æ‹’ç»</button>
          </div>
        </div>
      )}

      <div className="output-section">
        <h3>æ‰§è¡Œç»“æœ</h3>
        <pre className="output">
          {stream.messages.at(-1)?.content || "ç­‰å¾…æ‰§è¡Œ..."}
        </pre>
      </div>
    </div>
  );
}
```

## å®‰å…¨é…ç½®

### èµ„æºé™åˆ¶

```typescript
const RESOURCE_LIMITS = {
  modal: {
    timeout: 300,
    memory: 512,
    cpu: 1,
    diskSpace: 1024,
  },
  daytona: {
    timeout: 600,
    memory: 1024,
    cpu: 2,
    diskSpace: 2048,
  },
};
```

### ç½‘ç»œç­–ç•¥

```typescript
const NETWORK_POLICY = {
  allowOutbound: false,
  allowedDomains: ["pypi.org", "npmjs.com"],
  blockedPorts: [22, 23, 25, 3306, 5432],
};
```

## å°ç»“

æœ¬æ–‡æ„å»ºäº†ä¸€ä¸ªå®‰å…¨ä»£ç æ‰§è¡Œå¹³å°ï¼Œç»¼åˆè¿ç”¨äº†ï¼š

1. **æ²™ç®±ç³»ç»Ÿ**ï¼šModal å’Œ Daytona æ²™ç®±å®ç°ä»£ç éš”ç¦»æ‰§è¡Œ
2. **äººæœºåä½œ**ï¼šå±é™©æ“ä½œéœ€è¦äººå·¥å®¡æ‰¹
3. **å®‰å…¨åˆ†æ**ï¼šæ‰§è¡Œå‰è¿›è¡Œä»£ç å®‰å…¨æ£€æŸ¥
4. **æµå¼è¾“å‡º**ï¼šå®æ—¶æ˜¾ç¤ºæ‰§è¡Œè¿›åº¦å’Œè¾“å‡º
5. **å¤šè¯­è¨€æ”¯æŒ**ï¼šPythonã€JavaScriptã€Goã€Bash

ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªå¤šä»£ç†åä½œå·¥ä½œæµï¼Œæ¨¡æ‹Ÿå®Œæ•´çš„è½¯ä»¶å¼€å‘å›¢é˜Ÿã€‚
