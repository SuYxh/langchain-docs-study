# 36. é¡¹ç›®å®æˆ˜ï¼šAI æ—…æ¸¸è§„åˆ’å¸ˆ

## é¡¹ç›®æ¦‚è¿°

### ç®€å•æ¥è¯´

æ„å»ºä¸€ä¸ªæ™ºèƒ½æ—…æ¸¸è§„åˆ’åŠ©æ‰‹ï¼Œç”¨æˆ·åªéœ€è¯´"æˆ‘æƒ³å»æ­å·ç©3å¤©ï¼Œé¢„ç®—5000"ï¼Œç³»ç»Ÿå°±èƒ½è‡ªåŠ¨ï¼š
- æŸ¥è¯¢ç›®çš„åœ°å¤©æ°”
- æœç´¢æœºç¥¨/ç«è½¦ç¥¨
- æ¨èé…’åº—ä½å®¿
- è§„åˆ’æ™¯ç‚¹å’Œé¤å…
- ç”Ÿæˆå®Œæ•´çš„å¤šæ—¥è¡Œç¨‹è¡¨

ç”¨æˆ·å¯ä»¥åœ¨çº¿ä¿®æ”¹è¡Œç¨‹ï¼Œç¡®è®¤åä¿å­˜ã€‚

### æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | æè¿° |
|------|------|
| æ™ºèƒ½å¯¹è¯ | è‡ªç„¶è¯­è¨€ç†è§£ç”¨æˆ·å‡ºè¡Œéœ€æ±‚ |
| å¤šå·¥å…·å¹¶è¡Œ | åŒæ—¶æŸ¥è¯¢å¤©æ°”ã€äº¤é€šã€ä½å®¿ã€æ™¯ç‚¹ |
| è¡Œç¨‹è§„åˆ’ | è‡ªåŠ¨ç¼–æ’å¤šæ—¥è¡Œç¨‹ï¼Œåˆç†å®‰æ’æ—¶é—´ |
| è¡Œç¨‹ç¼–è¾‘ | å¯è§†åŒ–ç¼–è¾‘è¡Œç¨‹ï¼Œæ‹–æ‹½è°ƒæ•´é¡ºåº |
| è¡Œç¨‹ä¿å­˜ | ä¿å­˜å†å²è¡Œç¨‹ï¼Œæ”¯æŒåˆ†äº« |

### æŠ€æœ¯äº®ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI æ—…æ¸¸è§„åˆ’å¸ˆæŠ€æœ¯æ¶æ„                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‰ç«¯ï¼šReact 18 + TypeScript + Ant Design + Zustand         â”‚
â”‚  åç«¯ï¼šExpress + Prisma + MySQL + Redis                     â”‚
â”‚  AIï¼šLangChain 1.x + å¤šå·¥å…·å¹¶è¡Œ + ç»“æ„åŒ–è¾“å‡º                  â”‚
â”‚  å¤–éƒ¨APIï¼šé«˜å¾·åœ°å›¾ + å¤©æ°”API + 12306                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„

### 1.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å‰ç«¯å±‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  å¯¹è¯é¡µé¢  â”‚  â”‚  è¡Œç¨‹é¡µé¢  â”‚  â”‚  ç¼–è¾‘é¡µé¢  â”‚  â”‚  å†å²é¡µé¢  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                      â–¼                                              â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚              â”‚  Zustand Store â”‚  â† çŠ¶æ€ç®¡ç†                          â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ HTTP/SSE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â–¼              åç«¯å±‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      Express API Server                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚  â”‚ /chat   â”‚  â”‚ /trips  â”‚  â”‚ /users  â”‚  â”‚ /stream â”‚          â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚          â”‚            â”‚            â”‚            â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Service Layer                              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚
â”‚  â”‚  â”‚ ChatService â”‚  â”‚ TripService â”‚  â”‚ UserService â”‚           â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                â”‚                â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                     AI Agent Layer                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚              TravelPlannerAgent (LangChain)             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ Weather  â”‚ â”‚Transport â”‚ â”‚  Hotel   â”‚ â”‚   POI    â”‚   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â”‚  Tool    â”‚ â”‚  Tool    â”‚ â”‚  Tool    â”‚ â”‚  Tool    â”‚   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚            â”‚            â”‚            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â–¼            â–¼            â–¼            â–¼   å¤–éƒ¨APIå±‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   é«˜å¾·å¤©æ°”    â”‚ â”‚    12306    â”‚ â”‚   é«˜å¾·é…’åº—    â”‚ â”‚ é«˜å¾·POI  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â–¼                    æ•°æ®å±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚    MySQL     â”‚           â”‚    Redis     â”‚                        â”‚
â”‚  â”‚  (Prisma)    â”‚           â”‚   (ç¼“å­˜)     â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒæµç¨‹

```
ç”¨æˆ·è¾“å…¥ "æˆ‘æƒ³å»æ­å·ç©3å¤©ï¼Œé¢„ç®—5000"
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: éœ€æ±‚è§£æ                        â”‚
â”‚  æå–ï¼šç›®çš„åœ°=æ­å·, å¤©æ•°=3, é¢„ç®—=5000    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: å¹¶è¡Œä¿¡æ¯æ”¶é›†                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚æŸ¥å¤©æ°”    â”‚ â”‚æŸ¥äº¤é€š    â”‚ â”‚æŸ¥é…’åº—    â”‚   â”‚
â”‚  â”‚(å¼‚æ­¥)   â”‚ â”‚(å¼‚æ­¥)   â”‚ â”‚(å¼‚æ­¥)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: æ™¯ç‚¹æ¨è                        â”‚
â”‚  æ ¹æ®å¤©æ•°å’Œé¢„ç®—ï¼Œæ¨èåˆé€‚çš„æ™¯ç‚¹å’Œé¤å…     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: è¡Œç¨‹ç¼–æ’                        â”‚
â”‚  ç”Ÿæˆç»“æ„åŒ– JSON æ ¼å¼çš„å¤šæ—¥è¡Œç¨‹è¡¨        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: ç”¨æˆ·ç¡®è®¤                        â”‚
â”‚  å±•ç¤ºè¡Œç¨‹ â†’ ç”¨æˆ·ç¼–è¾‘ â†’ ç¡®è®¤ä¿å­˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€æ•°æ®åº“è®¾è®¡

### 2.1 ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      users       â”‚       â”‚   conversations  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)          â”‚â”€â”€â”€â”   â”‚ id (PK)          â”‚
â”‚ email            â”‚   â”‚   â”‚ userId (FK)      â”‚â”€â”€â”
â”‚ password         â”‚   â””â”€â”€â†’â”‚ title            â”‚  â”‚
â”‚ nickname         â”‚       â”‚ status           â”‚  â”‚
â”‚ avatar           â”‚       â”‚ createdAt        â”‚  â”‚
â”‚ createdAt        â”‚       â”‚ updatedAt        â”‚  â”‚
â”‚ updatedAt        â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚            â”‚
                                    â”‚            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚            â”‚
â”‚     messages     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
â”‚ id (PK)          â”‚                             â”‚
â”‚ conversationId   â”‚                             â”‚
â”‚ role             â”‚  (user/assistant/tool)      â”‚
â”‚ content          â”‚                             â”‚
â”‚ toolCalls        â”‚  (JSON)                     â”‚
â”‚ toolCallId       â”‚                             â”‚
â”‚ createdAt        â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
                                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚      trips       â”‚       â”‚   trip_days      â”‚ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ id (PK)          â”‚â”€â”€â”€â”   â”‚ id (PK)          â”‚ â”‚
â”‚ userId (FK)      â”‚â†â”€â”€â”¼â”€â”€â”€â”‚ tripId (FK)      â”‚ â”‚
â”‚ conversationId   â”‚â†â”€â”€â”¼â”€â”€â”€â”‚ dayNumber        â”‚ â”‚
â”‚ title            â”‚   â”‚   â”‚ date             â”‚ â”‚
â”‚ destination      â”‚   â”‚   â”‚ createdAt        â”‚ â”‚
â”‚ startDate        â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ endDate          â”‚   â”‚            â”‚           â”‚
â”‚ budget           â”‚   â”‚            â–¼           â”‚
â”‚ status           â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ weatherInfo      â”‚   â”‚   â”‚  trip_activities â”‚ â”‚
â”‚ transportInfo    â”‚   â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ hotelInfo        â”‚   â”‚   â”‚ id (PK)          â”‚ â”‚
â”‚ createdAt        â”‚   â”‚   â”‚ tripDayId (FK)   â”‚ â”‚
â”‚ updatedAt        â”‚   â”‚   â”‚ type             â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚ name             â”‚ â”‚
                       â”‚   â”‚ location         â”‚ â”‚
                       â”‚   â”‚ startTime        â”‚ â”‚
                       â”‚   â”‚ endTime          â”‚ â”‚
                       â”‚   â”‚ duration         â”‚ â”‚
                       â”‚   â”‚ cost             â”‚ â”‚
                       â”‚   â”‚ notes            â”‚ â”‚
                       â”‚   â”‚ order            â”‚ â”‚
                       â”‚   â”‚ poiId            â”‚ â”‚
                       â”‚   â”‚ poiData (JSON)   â”‚ â”‚
                       â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                       â”‚                        â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Prisma Schema

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  nickname      String?
  avatar        String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  conversations Conversation[]
  trips         Trip[]

  @@map("users")
}

model Conversation {
  id        String    @id @default(uuid())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String    @default("æ–°å¯¹è¯")
  status    String    @default("active") // active, archived
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  messages  Message[]
  trips     Trip[]

  @@index([userId])
  @@map("conversations")
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String       // user, assistant, tool
  content        String       @db.Text
  toolCalls      Json?        // å·¥å…·è°ƒç”¨ä¿¡æ¯
  toolCallId     String?      // å·¥å…·è°ƒç”¨IDï¼ˆtoolæ¶ˆæ¯æ—¶ä½¿ç”¨ï¼‰
  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@map("messages")
}

model Trip {
  id             String        @id @default(uuid())
  userId         String
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversationId String?
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  title          String
  destination    String
  startDate      DateTime
  endDate        DateTime
  budget         Decimal       @db.Decimal(10, 2)
  status         String        @default("draft") // draft, confirmed, completed
  weatherInfo    Json?         // å¤©æ°”ä¿¡æ¯ç¼“å­˜
  transportInfo  Json?         // äº¤é€šä¿¡æ¯ç¼“å­˜
  hotelInfo      Json?         // é…’åº—ä¿¡æ¯ç¼“å­˜
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  days           TripDay[]

  @@index([userId])
  @@index([conversationId])
  @@map("trips")
}

model TripDay {
  id         String         @id @default(uuid())
  tripId     String
  trip       Trip           @relation(fields: [tripId], references: [id], onDelete: Cascade)
  dayNumber  Int
  date       DateTime
  createdAt  DateTime       @default(now())
  activities TripActivity[]

  @@unique([tripId, dayNumber])
  @@index([tripId])
  @@map("trip_days")
}

model TripActivity {
  id        String   @id @default(uuid())
  tripDayId String
  tripDay   TripDay  @relation(fields: [tripDayId], references: [id], onDelete: Cascade)
  type      String   // attraction, restaurant, transport, hotel, free
  name      String
  location  String?
  startTime String   // HH:mm æ ¼å¼
  endTime   String   // HH:mm æ ¼å¼
  duration  Int      // åˆ†é’Ÿ
  cost      Decimal  @db.Decimal(10, 2)
  notes     String?  @db.Text
  order     Int      // æ’åºé¡ºåº
  poiId     String?  // é«˜å¾·POI ID
  poiData   Json?    // POIè¯¦ç»†æ•°æ®ç¼“å­˜

  @@index([tripDayId])
  @@map("trip_activities")
}
```

---

## ä¸‰ã€åç«¯ API è®¾è®¡

### 3.1 API æ¦‚è§ˆ

| æ¨¡å— | æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|------|
| **è®¤è¯** | POST | `/api/auth/register` | ç”¨æˆ·æ³¨å†Œ |
| | POST | `/api/auth/login` | ç”¨æˆ·ç™»å½• |
| | POST | `/api/auth/refresh` | åˆ·æ–°Token |
| | POST | `/api/auth/logout` | é€€å‡ºç™»å½• |
| **å¯¹è¯** | GET | `/api/conversations` | è·å–å¯¹è¯åˆ—è¡¨ |
| | POST | `/api/conversations` | åˆ›å»ºæ–°å¯¹è¯ |
| | GET | `/api/conversations/:id` | è·å–å¯¹è¯è¯¦æƒ… |
| | DELETE | `/api/conversations/:id` | åˆ é™¤å¯¹è¯ |
| **èŠå¤©** | POST | `/api/chat` | å‘é€æ¶ˆæ¯ï¼ˆéæµå¼ï¼‰ |
| | GET | `/api/chat/stream` | æµå¼èŠå¤©ï¼ˆSSEï¼‰ |
| **è¡Œç¨‹** | GET | `/api/trips` | è·å–è¡Œç¨‹åˆ—è¡¨ |
| | GET | `/api/trips/:id` | è·å–è¡Œç¨‹è¯¦æƒ… |
| | PUT | `/api/trips/:id` | æ›´æ–°è¡Œç¨‹ |
| | DELETE | `/api/trips/:id` | åˆ é™¤è¡Œç¨‹ |
| | POST | `/api/trips/:id/confirm` | ç¡®è®¤è¡Œç¨‹ |
| | PUT | `/api/trips/:id/activities` | æ‰¹é‡æ›´æ–°æ´»åŠ¨ |

### 3.2 API è¯¦ç»†è®¾è®¡

#### 3.2.1 è®¤è¯æ¨¡å—

```typescript
/**
 * @openapi
 * /api/auth/register:
 *   post:
 *     tags: [Auth]
 *     summary: ç”¨æˆ·æ³¨å†Œ
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required: [email, password]
 *             properties:
 *               email:
 *                 type: string
 *                 format: email
 *               password:
 *                 type: string
 *                 minLength: 6
 *               nickname:
 *                 type: string
 *     responses:
 *       201:
 *         description: æ³¨å†ŒæˆåŠŸ
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 accessToken:
 *                   type: string
 *                 refreshToken:
 *                   type: string
 *                 user:
 *                   $ref: '#/components/schemas/User'
 */

// è¯·æ±‚ä½“ Schema
const RegisterSchema = z.object({
  email: z.string().email("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"),
  password: z.string().min(6, "å¯†ç è‡³å°‘6ä½"),
  nickname: z.string().optional(),
});

// å“åº”ç¤ºä¾‹
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
  "user": {
    "id": "uuid",
    "email": "user@example.com",
    "nickname": "æ—…è¡Œè€…",
    "avatar": null,
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
}
```

#### 3.2.2 èŠå¤©æ¨¡å—ï¼ˆæ ¸å¿ƒï¼‰

```typescript
/**
 * @openapi
 * /api/chat/stream:
 *   get:
 *     tags: [Chat]
 *     summary: æµå¼èŠå¤©ï¼ˆSSEï¼‰
 *     parameters:
 *       - name: conversationId
 *         in: query
 *         required: true
 *         schema:
 *           type: string
 *       - name: message
 *         in: query
 *         required: true
 *         schema:
 *           type: string
 *     responses:
 *       200:
 *         description: SSE æµ
 *         content:
 *           text/event-stream:
 *             schema:
 *               type: string
 */

// SSE äº‹ä»¶ç±»å‹
type SSEEventType = 
  | "message_start"      // æ¶ˆæ¯å¼€å§‹
  | "content_delta"      // å†…å®¹å¢é‡
  | "tool_call_start"    // å·¥å…·è°ƒç”¨å¼€å§‹
  | "tool_call_delta"    // å·¥å…·è°ƒç”¨å‚æ•°å¢é‡
  | "tool_call_end"      // å·¥å…·è°ƒç”¨ç»“æŸ
  | "tool_result"        // å·¥å…·æ‰§è¡Œç»“æœ
  | "message_end"        // æ¶ˆæ¯ç»“æŸ
  | "trip_generated"     // è¡Œç¨‹ç”Ÿæˆå®Œæˆ
  | "error";             // é”™è¯¯

// SSE æ¶ˆæ¯æ ¼å¼
interface SSEMessage {
  event: SSEEventType;
  data: {
    id?: string;
    content?: string;
    toolCall?: {
      id: string;
      name: string;
      arguments: string;
    };
    toolResult?: {
      toolCallId: string;
      result: unknown;
    };
    trip?: Trip;
    error?: string;
  };
}

// SSE å“åº”ç¤ºä¾‹
event: message_start
data: {"id": "msg_1"}

event: content_delta
data: {"content": "å¥½çš„ï¼Œ"}

event: content_delta
data: {"content": "æˆ‘æ¥å¸®æ‚¨è§„åˆ’"}

event: tool_call_start
data: {"toolCall": {"id": "call_1", "name": "get_weather", "arguments": ""}}

event: tool_call_delta
data: {"toolCall": {"arguments": "{\"city\":"}}

event: tool_call_delta
data: {"toolCall": {"arguments": "\"æ­å·\"}"}}

event: tool_call_end
data: {"toolCall": {"id": "call_1"}}

event: tool_result
data: {"toolResult": {"toolCallId": "call_1", "result": {"temp": 25, "weather": "æ™´"}}}

event: trip_generated
data: {"trip": {"id": "trip_1", "title": "æ­å·3æ—¥æ¸¸", ...}}

event: message_end
data: {"id": "msg_1"}
```

#### 3.2.3 è¡Œç¨‹æ¨¡å—

```typescript
/**
 * @openapi
 * /api/trips/{id}:
 *   put:
 *     tags: [Trips]
 *     summary: æ›´æ–°è¡Œç¨‹
 *     parameters:
 *       - name: id
 *         in: path
 *         required: true
 *         schema:
 *           type: string
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             $ref: '#/components/schemas/UpdateTripInput'
 *     responses:
 *       200:
 *         description: æ›´æ–°æˆåŠŸ
 */

// æ›´æ–°è¡Œç¨‹ Schema
const UpdateTripSchema = z.object({
  title: z.string().optional(),
  startDate: z.string().datetime().optional(),
  endDate: z.string().datetime().optional(),
  budget: z.number().positive().optional(),
  days: z.array(z.object({
    id: z.string().optional(),
    dayNumber: z.number().int().positive(),
    date: z.string().datetime(),
    activities: z.array(z.object({
      id: z.string().optional(),
      type: z.enum(["attraction", "restaurant", "transport", "hotel", "free"]),
      name: z.string(),
      location: z.string().optional(),
      startTime: z.string().regex(/^\d{2}:\d{2}$/),
      endTime: z.string().regex(/^\d{2}:\d{2}$/),
      duration: z.number().int().positive(),
      cost: z.number().nonnegative(),
      notes: z.string().optional(),
      order: z.number().int(),
      poiId: z.string().optional(),
    })),
  })).optional(),
});

// è¡Œç¨‹å“åº”ç»“æ„
interface TripResponse {
  id: string;
  title: string;
  destination: string;
  startDate: string;
  endDate: string;
  budget: number;
  status: "draft" | "confirmed" | "completed";
  weatherInfo: WeatherInfo | null;
  transportInfo: TransportInfo | null;
  hotelInfo: HotelInfo | null;
  days: TripDayResponse[];
  createdAt: string;
  updatedAt: string;
}

interface TripDayResponse {
  id: string;
  dayNumber: number;
  date: string;
  activities: TripActivityResponse[];
}

interface TripActivityResponse {
  id: string;
  type: string;
  name: string;
  location: string | null;
  startTime: string;
  endTime: string;
  duration: number;
  cost: number;
  notes: string | null;
  order: number;
  poiId: string | null;
  poiData: POIData | null;
}
```

---

## å››ã€AI Agent è®¾è®¡

### 4.1 æ•´ä½“æ¶æ„æ¨¡å¼

æœ¬é¡¹ç›®é‡‡ç”¨ **Router + Sub-Agent** æ··åˆæ¨¡å¼ï¼Œæ ¸å¿ƒè®¾è®¡å¦‚ä¸‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç”¨æˆ·: "æˆ‘æƒ³å»æ­å·ç©3å¤©"                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ğŸ¯ Coordinator Agent (åè°ƒå™¨)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  èŒè´£ï¼š                                                                â”‚  â”‚
â”‚  â”‚  1. ç†è§£ç”¨æˆ·æ„å›¾ï¼Œæå–æ—…è¡Œå‚æ•°ï¼ˆç›®çš„åœ°ã€æ—¥æœŸã€å¤©æ•°ã€é¢„ç®—ã€åå¥½ï¼‰        â”‚  â”‚
â”‚  â”‚  2. æ ¹æ®æ„å›¾è·¯ç”±åˆ°å¯¹åº”çš„ Sub-Agent                                     â”‚  â”‚
â”‚  â”‚  3. æ•´åˆå„ Sub-Agent çš„ç»“æœï¼Œè¿”å›ç»™ç”¨æˆ·                                â”‚  â”‚
â”‚  â”‚  4. å¤„ç†ç”¨æˆ·çš„è¿½é—®å’Œè¡Œç¨‹ä¿®æ”¹è¯·æ±‚                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  è·¯ç”±å†³ç­–ï¼š                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ æ„å›¾ï¼šè§„åˆ’æ–°è¡Œç¨‹   â”‚  â”‚ æ„å›¾ï¼šæŸ¥è¯¢ä¿¡æ¯    â”‚  â”‚ æ„å›¾ï¼šä¿®æ”¹è¡Œç¨‹    â”‚           â”‚
â”‚  â”‚      â†“           â”‚  â”‚      â†“           â”‚  â”‚      â†“           â”‚           â”‚
â”‚  â”‚ â†’ Planner Agent  â”‚  â”‚ â†’ Info Agent     â”‚  â”‚ â†’ Adjuster Agent â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                          â”‚                          â”‚
         â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” Info Collector   â”‚  â”‚ ğŸ“‹ Trip Planner     â”‚  â”‚ âœï¸ Trip Adjuster    â”‚
â”‚    Sub-Agent        â”‚  â”‚    Sub-Agent        â”‚  â”‚    Sub-Agent        â”‚
â”‚                     â”‚  â”‚                     â”‚  â”‚                     â”‚
â”‚ å·¥å…·ï¼š              â”‚  â”‚ èƒ½åŠ›ï¼š              â”‚  â”‚ èƒ½åŠ›ï¼š              â”‚
â”‚ â€¢ get_weather       â”‚  â”‚ â€¢ æ¥æ”¶æ”¶é›†åˆ°çš„ä¿¡æ¯  â”‚  â”‚ â€¢ è§£æç”¨æˆ·ä¿®æ”¹æ„å›¾  â”‚
â”‚ â€¢ search_train      â”‚  â”‚ â€¢ ç»¼åˆåˆ†æå„ç±»æ•°æ®  â”‚  â”‚ â€¢ é‡æ–°è§„åˆ’æ—¶é—´å®‰æ’  â”‚
â”‚ â€¢ search_hotel      â”‚  â”‚ â€¢ æ™ºèƒ½ç¼–æ’è¡Œç¨‹      â”‚  â”‚ â€¢ å¤„ç†æ´»åŠ¨å¢åˆ æ”¹    â”‚
â”‚ â€¢ search_attraction â”‚  â”‚ â€¢ ä¼˜åŒ–æ—¶é—´å®‰æ’      â”‚  â”‚ â€¢ è§£å†³æ—¶é—´å†²çª      â”‚
â”‚ â€¢ search_restaurant â”‚  â”‚ â€¢ ç”Ÿæˆç»“æ„åŒ–è¾“å‡º    â”‚  â”‚ â€¢ æ›´æ–°è´¹ç”¨ä¼°ç®—      â”‚
â”‚ â€¢ plan_route        â”‚  â”‚                     â”‚  â”‚                     â”‚
â”‚ â€¢ get_current_date  â”‚  â”‚ è¾“å‡ºï¼šTripPlanSchemaâ”‚  â”‚ è¾“å‡ºï¼šæ›´æ–°åçš„è¡Œç¨‹  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                          â”‚                          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ğŸ“Š è¾“å‡ºå±‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ç»“æ„åŒ–è¡Œç¨‹ JSON  â†’  ä¿å­˜åˆ°æ•°æ®åº“  â†’  å‰ç«¯æ¸²æŸ“å±•ç¤º  â†’  ç”¨æˆ·ç¡®è®¤/ä¿®æ”¹  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªæ¶æ„ï¼Ÿ

#### 4.2.1 æ¶æ„å¯¹æ¯”

| æ¶æ„æ¨¡å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **å• Agent + å¤šå·¥å…·** | ç®€å•ç›´æ¥ | å¤æ‚ä»»åŠ¡æ—¶ Prompt è¿‡é•¿ï¼Œæ¨ç†è´Ÿæ‹…å¤§ | ç®€å•æŸ¥è¯¢åœºæ™¯ |
| **çº¯ Router æ¨¡å¼** | æ¸…æ™°çš„èŒè´£åˆ†ç¦» | ç¼ºä¹ä¸Šä¸‹æ–‡å…±äº«ï¼ŒAgent é—´åä½œå›°éš¾ | ç‹¬ç«‹ä»»åŠ¡åˆ†å‘ |
| **çº¯ Sub-Agent æ¨¡å¼** | çµæ´»çš„ä»»åŠ¡åˆ†è§£ | å¯èƒ½è¿‡åº¦åˆ†è§£ï¼Œè°ƒç”¨é“¾è¿‡é•¿ | å¤æ‚å¤šæ­¥éª¤ä»»åŠ¡ |
| **Router + Sub-Agent** âœ… | å…¼å…·è·¯ç”±çµæ´»æ€§å’Œä»»åŠ¡åˆ†è§£èƒ½åŠ› | å®ç°å¤æ‚åº¦ç¨é«˜ | æ—…æ¸¸è§„åˆ’è¿™ç±»å¤æ‚åœºæ™¯ |

#### 4.2.2 å…³é”®è®¾è®¡å†³ç­–

**Q: è¡Œç¨‹ç”Ÿæˆåº”è¯¥æ˜¯å·¥å…·è¿˜æ˜¯ Agentï¼Ÿ**

**A: åº”è¯¥æ˜¯ Agentï¼ˆTrip Planner Sub-Agentï¼‰**

ç†ç”±ï¼š
1. **å¤æ‚æ¨ç†**ï¼šè¡Œç¨‹ç”Ÿæˆéœ€è¦ç»¼åˆè€ƒè™‘å¤©æ°”ã€äº¤é€šã€æ™¯ç‚¹è·ç¦»ã€ç”¨é¤æ—¶é—´ã€ä½“åŠ›æ¶ˆè€—ç­‰å¤šä¸ªå› ç´ 
2. **åˆ›é€ æ€§ä»»åŠ¡**ï¼šéœ€è¦ LLM çš„åˆ›é€ åŠ›æ¥å®‰æ’æœ‰è¶£çš„è¡Œç¨‹ä¸»é¢˜å’ŒèŠ‚å¥
3. **é•¿è¾“å‡º**ï¼šç”Ÿæˆå¤šæ—¥è¡Œç¨‹æ˜¯é•¿æ–‡æœ¬ä»»åŠ¡ï¼Œä½œä¸ºå·¥å…·è¿”å›å®¹æ˜“è¢«æˆªæ–­
4. **è¿­ä»£ä¼˜åŒ–**ï¼šå¯èƒ½éœ€è¦å¤šè½®è°ƒæ•´ï¼ŒAgent æ¯”å·¥å…·æ›´é€‚åˆè¿™ç§åœºæ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è¡Œç¨‹ç”Ÿæˆä¸ºä»€ä¹ˆä¸æ˜¯å·¥å…·ï¼Ÿ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  å·¥å…·ï¼ˆToolï¼‰çš„å®šä½ï¼š                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ æ‰§è¡Œç¡®å®šæ€§æ“ä½œï¼ˆå¦‚è°ƒç”¨ API æŸ¥è¯¢æ•°æ®ï¼‰                      â”‚   â”‚
â”‚  â”‚  â€¢ è¾“å…¥æ˜ç¡®ï¼Œè¾“å‡ºå¯é¢„æµ‹                                       â”‚   â”‚
â”‚  â”‚  â€¢ ä¸éœ€è¦å¤æ‚æ¨ç†                                            â”‚   â”‚
â”‚  â”‚  â€¢ ä¾‹å¦‚ï¼šæŸ¥å¤©æ°”ã€æŸ¥ç«è½¦ç¥¨ã€æœç´¢ POI                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  Agent çš„å®šä½ï¼š                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â€¢ éœ€è¦å¤æ‚æ¨ç†å’Œå†³ç­–                                         â”‚   â”‚
â”‚  â”‚  â€¢ è¾“å…¥å¯èƒ½æ¨¡ç³Šï¼Œè¾“å‡ºéœ€è¦åˆ›é€ æ€§                                â”‚   â”‚
â”‚  â”‚  â€¢ å¯èƒ½éœ€è¦å¤šè½®æ€è€ƒå’Œè°ƒæ•´                                     â”‚   â”‚
â”‚  â”‚  â€¢ ä¾‹å¦‚ï¼šè¡Œç¨‹è§„åˆ’ã€è¡Œç¨‹ä¼˜åŒ–ã€å†²çªè§£å†³                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚  è¡Œç¨‹ç”Ÿæˆçš„ç‰¹ç‚¹ï¼š                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  âœ“ éœ€è¦ç»¼åˆåˆ†æå¤©æ°”ã€äº¤é€šã€æ™¯ç‚¹ç­‰å¤šæºä¿¡æ¯                     â”‚   â”‚
â”‚  â”‚  âœ“ éœ€è¦åˆ›é€ æ€§åœ°å®‰æ’æ¯å¤©çš„ä¸»é¢˜å’ŒèŠ‚å¥                           â”‚   â”‚
â”‚  â”‚  âœ“ éœ€è¦è€ƒè™‘æ™¯ç‚¹åœ°ç†ä½ç½®è¿›è¡Œè·¯çº¿ä¼˜åŒ–                           â”‚   â”‚
â”‚  â”‚  âœ“ éœ€è¦å¹³è¡¡ç”¨æˆ·é¢„ç®—å’Œä½“éªŒ                                     â”‚   â”‚
â”‚  â”‚  âœ“ è¾“å‡ºæ˜¯å¤æ‚çš„å¤šæ—¥è¡Œç¨‹ç»“æ„                                   â”‚   â”‚
â”‚  â”‚  â†’ ç»“è®ºï¼šåº”è¯¥æ˜¯ Agentï¼Œè€Œé Tool                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 Agent è¯¦ç»†è®¾è®¡

#### 4.3.1 Coordinator Agentï¼ˆåè°ƒå™¨ï¼‰

```typescript
// src/agent/coordinator.agent.ts

const COORDINATOR_SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªæ—…æ¸¸è§„åˆ’åè°ƒå‘˜ï¼Œè´Ÿè´£ç†è§£ç”¨æˆ·éœ€æ±‚å¹¶åˆ†é…ä»»åŠ¡ç»™ä¸“ä¸šçš„åŠ©æ‰‹ã€‚

## ä½ çš„èŒè´£
1. ç†è§£ç”¨æˆ·çš„æ—…è¡Œæ„å›¾
2. æå–å…³é”®ä¿¡æ¯ï¼šç›®çš„åœ°ã€æ—¥æœŸã€å¤©æ•°ã€é¢„ç®—ã€åå¥½ã€äººæ•°
3. åˆ¤æ–­ç”¨æˆ·æ„å›¾ç±»å‹å¹¶è·¯ç”±åˆ°å¯¹åº”çš„å¤„ç†æµç¨‹
4. æ•´åˆç»“æœå¹¶å‹å¥½åœ°å›å¤ç”¨æˆ·

## æ„å›¾ç±»å‹
- **plan_trip**ï¼šç”¨æˆ·æƒ³è§„åˆ’æ–°çš„æ—…è¡Œï¼ˆå¦‚"æˆ‘æƒ³å»æ­å·ç©"ï¼‰
- **query_info**ï¼šç”¨æˆ·åªæ˜¯æŸ¥è¯¢ä¿¡æ¯ï¼ˆå¦‚"æ­å·æ˜å¤©å¤©æ°”æ€ä¹ˆæ ·"ï¼‰
- **modify_trip**ï¼šç”¨æˆ·æƒ³ä¿®æ”¹å·²æœ‰è¡Œç¨‹ï¼ˆå¦‚"æŠŠç¬¬äºŒå¤©çš„è¥¿æ¹–æ¢æˆçµéšå¯º"ï¼‰
- **general_chat**ï¼šé—²èŠæˆ–å…¶ä»–ï¼ˆå¦‚"ä½ å¥½"ï¼‰

## è¾“å‡ºæ ¼å¼
åˆ†æç”¨æˆ·æ„å›¾åï¼Œè¾“å‡º JSONï¼š
{
  "intent": "plan_trip" | "query_info" | "modify_trip" | "general_chat",
  "params": {
    "destination": "æ­å·",
    "days": 3,
    "budget": 5000,
    "startDate": "2024-02-01",
    "travelers": 2,
    "preferences": ["è‡ªç„¶é£æ™¯", "ç¾é£Ÿ"]
  },
  "nextAction": "æè¿°ä¸‹ä¸€æ­¥æ“ä½œ"
}`;
```

#### 4.3.2 Info Collector Sub-Agentï¼ˆä¿¡æ¯æ”¶é›†å™¨ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Info Collector Sub-Agent                          â”‚
â”‚                       ä¿¡æ¯æ”¶é›†ä¸“å®¶                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  è¾“å…¥ï¼š{ destination: "æ­å·", days: 3, startDate: "2024-02-01" }     â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              å¹¶è¡Œè°ƒç”¨å¤šä¸ªå·¥å…·ï¼ˆå¤šå·¥å…·å¹¶è¡Œï¼‰                     â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚   â”‚ Weather  â”‚ â”‚Transport â”‚ â”‚  Hotel   â”‚ â”‚Attractionâ”‚       â”‚    â”‚
â”‚  â”‚   â”‚   Tool   â”‚ â”‚   Tool   â”‚ â”‚   Tool   â”‚ â”‚   Tool   â”‚       â”‚    â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â”‚        â”‚            â”‚            â”‚            â”‚              â”‚    â”‚
â”‚  â”‚        â–¼            â–¼            â–¼            â–¼              â”‚    â”‚
â”‚  â”‚   3å¤©å¤©æ°”é¢„æŠ¥   é«˜é“ç¥¨ä¿¡æ¯   é…’åº—åˆ—è¡¨    çƒ­é—¨æ™¯ç‚¹            â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚    â”‚
â”‚  â”‚   â”‚Restaurantâ”‚ â”‚  Route   â”‚                                  â”‚    â”‚
â”‚  â”‚   â”‚   Tool   â”‚ â”‚   Tool   â”‚                                  â”‚    â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                  â”‚    â”‚
â”‚  â”‚        â”‚            â”‚                                        â”‚    â”‚
â”‚  â”‚        â–¼            â–¼                                        â”‚    â”‚
â”‚  â”‚   é¤å…æ¨è      æ™¯ç‚¹é—´è·¯çº¿                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  è¾“å‡ºï¼šCollectedInfo ç»“æ„åŒ–æ•°æ®                                      â”‚
â”‚  {                                                                   â”‚
â”‚    weather: [...],                                                   â”‚
â”‚    transport: [...],                                                 â”‚
â”‚    hotels: [...],                                                    â”‚
â”‚    attractions: [...],                                               â”‚
â”‚    restaurants: [...],                                               â”‚
â”‚    routes: [...]                                                     â”‚
â”‚  }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3.3 Trip Planner Sub-Agentï¼ˆè¡Œç¨‹è§„åˆ’å™¨ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Trip Planner Sub-Agent                            â”‚
â”‚                       è¡Œç¨‹è§„åˆ’ä¸“å®¶                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  è¾“å…¥ï¼šCollectedInfo + UserPreferences                              â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    æ™ºèƒ½è§„åˆ’é€»è¾‘                               â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚  1. åˆ†ææ™¯ç‚¹åœ°ç†ä½ç½® â†’ èšç±»åˆ†ç»„ï¼ˆç›¸è¿‘æ™¯ç‚¹æ”¾åŒä¸€å¤©ï¼‰          â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚  2. è€ƒè™‘å¤©æ°”å› ç´ ï¼š                                           â”‚    â”‚
â”‚  â”‚     â€¢ é›¨å¤© â†’ å®¤å†…æ™¯ç‚¹ï¼ˆåšç‰©é¦†ã€å•†åœºï¼‰                        â”‚    â”‚
â”‚  â”‚     â€¢ æ™´å¤© â†’ æˆ·å¤–æ™¯ç‚¹ï¼ˆè¥¿æ¹–ã€å…¬å›­ï¼‰                          â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚  3. æ—¶é—´å®‰æ’åŸåˆ™ï¼š                                           â”‚    â”‚
â”‚  â”‚     â€¢ 08:00 æ—©é¤                                             â”‚    â”‚
â”‚  â”‚     â€¢ 09:00-12:00 ä¸Šåˆæ™¯ç‚¹ï¼ˆ2ä¸ªï¼‰                            â”‚    â”‚
â”‚  â”‚     â€¢ 12:00-13:30 åˆé¤                                       â”‚    â”‚
â”‚  â”‚     â€¢ 14:00-17:30 ä¸‹åˆæ™¯ç‚¹ï¼ˆ2ä¸ªï¼‰                            â”‚    â”‚
â”‚  â”‚     â€¢ 18:00-19:30 æ™šé¤                                       â”‚    â”‚
â”‚  â”‚     â€¢ 20:00+ å¤œé—´æ´»åŠ¨ï¼ˆå¯é€‰ï¼‰                                â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚  4. è·¯çº¿ä¼˜åŒ–ï¼š                                               â”‚    â”‚
â”‚  â”‚     â€¢ ä½¿ç”¨è·¯çº¿è§„åˆ’ API è®¡ç®—æ™¯ç‚¹é—´äº¤é€šæ—¶é—´                    â”‚    â”‚
â”‚  â”‚     â€¢ é¿å…æ¥å›æŠ˜è…¾                                           â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚  5. é¢„ç®—æ§åˆ¶ï¼š                                               â”‚    â”‚
â”‚  â”‚     â€¢ è®¡ç®—æ€»è´¹ç”¨ä¼°ç®—                                         â”‚    â”‚
â”‚  â”‚     â€¢ è¶…é¢„ç®—æ—¶è°ƒæ•´é…’åº—/é¤å…çº§åˆ«                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  è¾“å‡ºï¼šTripPlan ç»“æ„åŒ–è¡Œç¨‹                                          â”‚
â”‚  {                                                                   â”‚
â”‚    title: "æ­å·3æ—¥ä¼‘é—²æ¸¸",                                          â”‚
â”‚    summary: "...",                                                   â”‚
â”‚    totalBudget: 4500,                                                â”‚
â”‚    days: [                                                           â”‚
â”‚      {                                                               â”‚
â”‚        dayNumber: 1,                                                 â”‚
â”‚        theme: "è¥¿æ¹–ç»å…¸æ¸¸",                                          â”‚
â”‚        activities: [...]                                             â”‚
â”‚      },                                                              â”‚
â”‚      ...                                                             â”‚
â”‚    ]                                                                 â”‚
â”‚  }                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.3.4 Trip Adjuster Sub-Agentï¼ˆè¡Œç¨‹è°ƒæ•´å™¨ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Trip Adjuster Sub-Agent                           â”‚
â”‚                       è¡Œç¨‹è°ƒæ•´ä¸“å®¶                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  è¾“å…¥ï¼šç°æœ‰è¡Œç¨‹ + ç”¨æˆ·ä¿®æ”¹è¯·æ±‚                                       â”‚
â”‚                                                                      â”‚
â”‚  å¤„ç†åœºæ™¯ï¼š                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  åœºæ™¯1ï¼šæ›¿æ¢æ´»åŠ¨                                             â”‚    â”‚
â”‚  â”‚  "æŠŠç¬¬äºŒå¤©çš„è¥¿æ¹–æ¢æˆçµéšå¯º"                                   â”‚    â”‚
â”‚  â”‚  â†’ æ‰¾åˆ°å¯¹åº”æ´»åŠ¨ â†’ æœç´¢æ–°æ™¯ç‚¹ä¿¡æ¯ â†’ æ›¿æ¢ â†’ è°ƒæ•´æ—¶é—´           â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚  åœºæ™¯2ï¼šå¢åŠ æ´»åŠ¨                                             â”‚    â”‚
â”‚  â”‚  "ç¬¬ä¸€å¤©æ™šä¸Šæƒ³å»çœ‹å°è±¡è¥¿æ¹–"                                   â”‚    â”‚
â”‚  â”‚  â†’ æœç´¢æ´»åŠ¨ä¿¡æ¯ â†’ æ£€æŸ¥æ—¶é—´å†²çª â†’ æ’å…¥æ´»åŠ¨ â†’ è°ƒæ•´åç»­æ—¶é—´     â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚  åœºæ™¯3ï¼šåˆ é™¤æ´»åŠ¨                                             â”‚    â”‚
â”‚  â”‚  "ç¬¬ä¸‰å¤©çš„æ²³åŠè¡—æˆ‘ä¸æƒ³å»äº†"                                   â”‚    â”‚
â”‚  â”‚  â†’ æ‰¾åˆ°å¯¹åº”æ´»åŠ¨ â†’ åˆ é™¤ â†’ é‡æ–°åˆ†é…æ—¶é—´æˆ–æ¨èæ›¿ä»£              â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚  åœºæ™¯4ï¼šè°ƒæ•´é¡ºåº                                             â”‚    â”‚
â”‚  â”‚  "è¥¿æºªæ¹¿åœ°æ”¾åˆ°æœ€åä¸€å¤©"                                       â”‚    â”‚
â”‚  â”‚  â†’ æ‰¾åˆ°å¯¹åº”æ´»åŠ¨ â†’ ç§»åŠ¨ä½ç½® â†’ é‡æ–°ä¼˜åŒ–è·¯çº¿                    â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚  åœºæ™¯5ï¼šæ—¶é—´å†²çªè§£å†³                                         â”‚    â”‚
â”‚  â”‚  æ£€æµ‹åˆ°å†²çª â†’ è‡ªåŠ¨è°ƒæ•´ â†’ ç»™å‡ºè°ƒæ•´è¯´æ˜                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  è¾“å‡ºï¼šæ›´æ–°åçš„ TripPlan + ä¿®æ”¹è¯´æ˜                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 å®Œæ•´å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å®Œæ•´å·¥ä½œæµç¨‹ç¤ºä¾‹                                    â”‚
â”‚                    ç”¨æˆ·: "æˆ‘æƒ³å»æ­å·ç©3å¤©ï¼Œé¢„ç®—5000"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Coordinator Agent åˆ†ææ„å›¾                                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ è¾“å‡º: {                                                                      â”‚
â”‚   intent: "plan_trip",                                                       â”‚
â”‚   params: { destination: "æ­å·", days: 3, budget: 5000 },                    â”‚
â”‚   nextAction: "è°ƒç”¨ Info Collector æ”¶é›†ä¿¡æ¯"                                 â”‚
â”‚ }                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Info Collector Sub-Agent å¹¶è¡Œæ”¶é›†ä¿¡æ¯                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ å¤©æ°”æŸ¥è¯¢     â”‚ â”‚ ç«è½¦ç¥¨æŸ¥è¯¢  â”‚ â”‚ é…’åº—æœç´¢     â”‚ â”‚ æ™¯ç‚¹æœç´¢     â”‚            â”‚
â”‚  â”‚ get_weather â”‚ â”‚search_trainâ”‚ â”‚search_hotel â”‚ â”‚search_attracâ”‚            â”‚
â”‚  â”‚     â†“       â”‚ â”‚     â†“      â”‚ â”‚     â†“       â”‚ â”‚     â†“       â”‚            â”‚
â”‚  â”‚ æ­å·3å¤©æ™´   â”‚ â”‚ G7501 Â¥73  â”‚ â”‚ å¦‚å®¶ Â¥299   â”‚ â”‚ è¥¿æ¹– 4.9åˆ†   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚ é¤å…æœç´¢     â”‚ â”‚ è·¯çº¿è§„åˆ’     â”‚                                            â”‚
â”‚  â”‚search_resta â”‚ â”‚ plan_route â”‚                                            â”‚
â”‚  â”‚     â†“       â”‚ â”‚     â†“      â”‚                                            â”‚
â”‚  â”‚ å¤–å©†å®¶ 4.5åˆ†â”‚ â”‚ è¥¿æ¹–â†’çµéšå¯º â”‚                                            â”‚
â”‚  â”‚             â”‚ â”‚ 25åˆ†é’Ÿ     â”‚                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                                                                              â”‚
â”‚ è¾“å‡º: CollectedInfo { weather, transport, hotels, attractions, ... }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Trip Planner Sub-Agent ç”Ÿæˆè¡Œç¨‹                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                              â”‚
â”‚  è¾“å…¥ï¼šCollectedInfo + { budget: 5000, days: 3 }                            â”‚
â”‚                                                                              â”‚
â”‚  è§„åˆ’é€»è¾‘ï¼š                                                                  â”‚
â”‚  â€¢ Day1: è¥¿æ¹–æ ¸å¿ƒåŒºï¼ˆè¥¿æ¹– â†’ æ–­æ¡¥ â†’ ç™½å ¤ â†’ æ›²é™¢é£è·ï¼‰                        â”‚
â”‚  â€¢ Day2: å†å²äººæ–‡åŒºï¼ˆçµéšå¯º â†’ é£æ¥å³° â†’ é¾™äº•èŒ¶æ‘ï¼‰                           â”‚
â”‚  â€¢ Day3: ç°ä»£æ­å·ï¼ˆè¥¿æºªæ¹¿åœ° â†’ æ²³åŠè¡— â†’ é’±å¡˜æ±Ÿï¼‰                             â”‚
â”‚                                                                              â”‚
â”‚  è¾“å‡º: TripPlan JSON                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: è¿”å›ç”¨æˆ· & ä¿å­˜                                                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                              â”‚
â”‚  â€¢ æµå¼è¾“å‡ºè§„åˆ’è¿‡ç¨‹å’Œç»“æœç»™å‰ç«¯                                              â”‚
â”‚  â€¢ ä¿å­˜è¡Œç¨‹åˆ°æ•°æ®åº“ï¼ˆstatus: draftï¼‰                                         â”‚
â”‚  â€¢ å‰ç«¯æ¸²æŸ“å¯è§†åŒ–è¡Œç¨‹å¡ç‰‡                                                    â”‚
â”‚  â€¢ ç”¨æˆ·å¯ç¼–è¾‘/ç¡®è®¤                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: (å¯é€‰) ç”¨æˆ·ä¿®æ”¹ â†’ Trip Adjuster                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                              â”‚
â”‚  ç”¨æˆ·: "çµéšå¯ºæ¢æˆå®‹åŸ"                                                      â”‚
â”‚                                                                              â”‚
â”‚  â†’ Coordinator è¯†åˆ«ä¸º modify_trip æ„å›¾                                       â”‚
â”‚  â†’ è°ƒç”¨ Trip Adjuster Sub-Agent                                             â”‚
â”‚  â†’ æœç´¢å®‹åŸä¿¡æ¯ â†’ æ›¿æ¢çµéšå¯º â†’ é‡æ–°ä¼˜åŒ–è·¯çº¿                                  â”‚
â”‚  â†’ è¿”å›æ›´æ–°åçš„è¡Œç¨‹                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.5 å·¥å…·å®šä¹‰ï¼ˆå…± 8 ä¸ªå·¥å…·ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å·¥å…·æ¦‚è§ˆ                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   åºå·   â”‚   å·¥å…·åç§°        â”‚   åŠŸèƒ½æè¿°           â”‚   å¤–éƒ¨ API            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚    1    â”‚ get_weather       â”‚ æŸ¥è¯¢å¤©æ°”é¢„æŠ¥         â”‚ é«˜å¾·å¤©æ°” API           â”‚
â”‚    2    â”‚ search_train      â”‚ æŸ¥è¯¢ç«è½¦ç¥¨           â”‚ 12306 API             â”‚
â”‚    3    â”‚ search_hotel      â”‚ æœç´¢é…’åº—             â”‚ é«˜å¾· POI API          â”‚
â”‚    4    â”‚ search_attraction â”‚ æœç´¢æ™¯ç‚¹ â­ NEW      â”‚ é«˜å¾· POI API          â”‚
â”‚    5    â”‚ search_restaurant â”‚ æœç´¢é¤å… â­ NEW      â”‚ é«˜å¾· POI API          â”‚
â”‚    6    â”‚ plan_route        â”‚ è·¯çº¿è§„åˆ’ â­ NEW      â”‚ é«˜å¾·è·¯çº¿è§„åˆ’ API       â”‚
â”‚    7    â”‚ get_current_date  â”‚ è·å–å½“å‰æ—¥æœŸ         â”‚ æœ¬åœ°                   â”‚
â”‚    8    â”‚ search_poi        â”‚ é€šç”¨ POI æœç´¢        â”‚ é«˜å¾· POI API          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.5.1 å¤©æ°”æŸ¥è¯¢å·¥å…·

```typescript
// src/agent/tools/weather.tool.ts
import { tool } from "@langchain/core/tools";
import { z } from "zod";
import { AmapService } from "@/services/amap.service";

export const getWeatherTool = tool(
  async ({ city }) => {
    const amapService = new AmapService();
    const weather = await amapService.getWeather(city);
    
    return JSON.stringify({
      city,
      current: {
        temperature: weather.lives[0].temperature,
        weather: weather.lives[0].weather,
        humidity: weather.lives[0].humidity,
        windDirection: weather.lives[0].winddirection,
        windPower: weather.lives[0].windpower,
      },
      forecast: weather.forecasts[0]?.casts.map((cast: any) => ({
        date: cast.date,
        week: cast.week,
        dayWeather: cast.dayweather,
        nightWeather: cast.nightweather,
        dayTemp: cast.daytemp,
        nightTemp: cast.nighttemp,
      })),
    });
  },
  {
    name: "get_weather",
    description: "è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”ä¿¡æ¯ï¼ŒåŒ…æ‹¬å½“å‰å¤©æ°”å’Œæœªæ¥å‡ å¤©çš„å¤©æ°”é¢„æŠ¥",
    schema: z.object({
      city: z.string().describe("åŸå¸‚åç§°ï¼Œå¦‚ï¼šæ­å·ã€åŒ—äº¬ã€ä¸Šæµ·"),
    }),
  }
);
```

#### 4.5.2 ç«è½¦ç¥¨æŸ¥è¯¢å·¥å…·

```typescript
// src/agent/tools/transport.tool.ts
import { tool } from "@langchain/core/tools";
import { z } from "zod";
import { TrainService } from "@/services/train.service";

export const searchTrainTool = tool(
  async ({ from, to, date }) => {
    const trainService = new TrainService();
    const tickets = await trainService.searchTickets(from, to, date);
    
    // åªè¿”å›å‰10æ¡ï¼Œé¿å…ä¿¡æ¯è¿‡å¤š
    const topTickets = tickets.slice(0, 10).map((ticket: any) => ({
      trainNo: ticket.trainNo,
      from: ticket.fromStation,
      to: ticket.toStation,
      departTime: ticket.departTime,
      arriveTime: ticket.arriveTime,
      duration: ticket.duration,
      prices: {
        secondClass: ticket.secondClassPrice,
        firstClass: ticket.firstClassPrice,
        businessClass: ticket.businessClassPrice,
      },
      seats: {
        secondClass: ticket.secondClassSeats,
        firstClass: ticket.firstClassSeats,
      },
    }));
    
    return JSON.stringify({
      from,
      to,
      date,
      tickets: topTickets,
      total: tickets.length,
    });
  },
  {
    name: "search_train",
    description: "æœç´¢ç«è½¦ç¥¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬è½¦æ¬¡ã€æ—¶é—´ã€ä»·æ ¼å’Œä½™ç¥¨",
    schema: z.object({
      from: z.string().describe("å‡ºå‘åŸå¸‚"),
      to: z.string().describe("åˆ°è¾¾åŸå¸‚"),
      date: z.string().describe("å‡ºå‘æ—¥æœŸï¼Œæ ¼å¼ï¼šYYYY-MM-DD"),
    }),
  }
);
```

#### 4.5.3 é…’åº—æœç´¢å·¥å…·

```typescript
// src/agent/tools/hotel.tool.ts
import { tool } from "@langchain/core/tools";
import { z } from "zod";
import { AmapService } from "@/services/amap.service";

export const searchHotelTool = tool(
  async ({ city, keywords, priceRange }) => {
    const amapService = new AmapService();
    
    // å…ˆè·å–åŸå¸‚çš„åæ ‡
    const geocode = await amapService.geocode(city);
    const location = geocode.geocodes[0]?.location;
    
    if (!location) {
      return JSON.stringify({ error: "æ— æ³•æ‰¾åˆ°è¯¥åŸå¸‚" });
    }
    
    // æœç´¢å‘¨è¾¹é…’åº—
    const hotels = await amapService.searchPOI({
      keywords: keywords || "é…’åº—",
      city,
      types: "100100", // é…’åº—ç±»å‹
      radius: 10000,
    });
    
    // è¿‡æ»¤å’Œæ’åº
    let filteredHotels = hotels.pois || [];
    
    if (priceRange) {
      // æ ¹æ®ä»·æ ¼èŒƒå›´è¿‡æ»¤ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦é…’åº—ä»·æ ¼APIï¼‰
    }
    
    const result = filteredHotels.slice(0, 10).map((hotel: any) => ({
      id: hotel.id,
      name: hotel.name,
      address: hotel.address,
      location: hotel.location,
      tel: hotel.tel,
      rating: hotel.biz_ext?.rating,
      distance: hotel.distance,
    }));
    
    return JSON.stringify({
      city,
      hotels: result,
      total: filteredHotels.length,
    });
  },
  {
    name: "search_hotel",
    description: "æœç´¢é…’åº—ä¿¡æ¯ï¼Œæ”¯æŒæŒ‰åŸå¸‚ã€å…³é”®è¯å’Œä»·æ ¼èŒƒå›´ç­›é€‰",
    schema: z.object({
      city: z.string().describe("åŸå¸‚åç§°"),
      keywords: z.string().optional().describe("æœç´¢å…³é”®è¯ï¼Œå¦‚ï¼šäº”æ˜Ÿçº§ã€ç»æµå‹"),
      priceRange: z.object({
        min: z.number().describe("æœ€ä½ä»·æ ¼"),
        max: z.number().describe("æœ€é«˜ä»·æ ¼"),
      }).optional().describe("ä»·æ ¼èŒƒå›´"),
    }),
  }
);
```

#### 4.5.4 æ™¯ç‚¹æœç´¢å·¥å…·ï¼ˆNEWï¼‰

```typescript
// src/agent/tools/attraction.tool.ts
import { tool } from "@langchain/core/tools";
import { z } from "zod";
import { AmapService } from "@/services/amap.service";

export const searchAttractionTool = tool(
  async ({ city, keywords, sortBy }) => {
    const amapService = new AmapService();
    
    const pois = await amapService.searchPOI({
      keywords: keywords || "æ™¯ç‚¹",
      city,
      types: "110000", // é£æ™¯åèƒœç±»å‹
      page_size: 20,
    });
    
    let attractions = (pois.pois || []).map((poi: any) => ({
      id: poi.id,
      name: poi.name,
      type: poi.type,
      address: poi.address,
      location: poi.location,
      tel: poi.tel,
      rating: parseFloat(poi.biz_ext?.rating || "0"),
      cost: poi.biz_ext?.cost || "å…è´¹",
      openTime: poi.biz_ext?.open_time || "å…¨å¤©",
      photos: poi.photos?.slice(0, 3).map((p: any) => p.url),
      tags: poi.biz_ext?.tag?.split(";") || [],
    }));
    
    // æ’åº
    if (sortBy === "rating") {
      attractions.sort((a: any, b: any) => b.rating - a.rating);
    } else if (sortBy === "cost") {
      attractions.sort((a: any, b: any) => {
        const costA = a.cost === "å…è´¹" ? 0 : parseInt(a.cost) || 999;
        const costB = b.cost === "å…è´¹" ? 0 : parseInt(b.cost) || 999;
        return costA - costB;
      });
    }
    
    return JSON.stringify({
      city,
      attractions: attractions.slice(0, 15),
      total: pois.count,
      tips: "å»ºè®®æ¯å¤©å®‰æ’2-3ä¸ªæ™¯ç‚¹ï¼Œé¢„ç•™å……è¶³çš„äº¤é€šå’Œä¼‘æ¯æ—¶é—´",
    });
  },
  {
    name: "search_attraction",
    description: `æœç´¢åŸå¸‚çš„æ—…æ¸¸æ™¯ç‚¹ï¼ŒåŒ…æ‹¬æ™¯åŒºã€å…¬å›­ã€å¤è¿¹ã€åšç‰©é¦†ç­‰ã€‚
è¿”å›æ™¯ç‚¹çš„è¯„åˆ†ã€é—¨ç¥¨ä»·æ ¼ã€å¼€æ”¾æ—¶é—´ç­‰ä¿¡æ¯ã€‚
å»ºè®®ç”¨äºè§„åˆ’è¡Œç¨‹æ—¶è·å–æ™¯ç‚¹åˆ—è¡¨ã€‚`,
    schema: z.object({
      city: z.string().describe("åŸå¸‚åç§°ï¼Œå¦‚ï¼šæ­å·ã€åŒ—äº¬"),
      keywords: z.string().optional().describe("æœç´¢å…³é”®è¯ï¼Œå¦‚ï¼šè¥¿æ¹–ã€å¤é•‡ã€åšç‰©é¦†"),
      sortBy: z.enum(["rating", "cost", "default"])
        .optional()
        .default("rating")
        .describe("æ’åºæ–¹å¼ï¼šrating(è¯„åˆ†)ã€cost(ä»·æ ¼)ã€default(é»˜è®¤)"),
    }),
  }
);
```

#### 4.5.5 é¤å…æœç´¢å·¥å…·ï¼ˆNEWï¼‰

```typescript
// src/agent/tools/restaurant.tool.ts
import { tool } from "@langchain/core/tools";
import { z } from "zod";
import { AmapService } from "@/services/amap.service";

export const searchRestaurantTool = tool(
  async ({ city, keywords, cuisine, priceLevel, nearLocation }) => {
    const amapService = new AmapService();
    
    // æ„å»ºæœç´¢å…³é”®è¯
    let searchKeywords = keywords || "é¤å…";
    if (cuisine) {
      searchKeywords = `${cuisine} ${searchKeywords}`;
    }
    
    let searchParams: any = {
      keywords: searchKeywords,
      city,
      types: "050000", // é¤é¥®æœåŠ¡ç±»å‹
      page_size: 20,
    };
    
    // å¦‚æœæä¾›äº†ä½ç½®ï¼Œæœç´¢å‘¨è¾¹
    if (nearLocation) {
      searchParams.location = nearLocation;
      searchParams.radius = 3000; // 3å…¬é‡ŒèŒƒå›´
    }
    
    const pois = await amapService.searchPOI(searchParams);
    
    let restaurants = (pois.pois || []).map((poi: any) => ({
      id: poi.id,
      name: poi.name,
      type: poi.type,
      cuisine: poi.biz_ext?.keytag || "ç»¼åˆ",
      address: poi.address,
      location: poi.location,
      tel: poi.tel,
      rating: parseFloat(poi.biz_ext?.rating || "0"),
      avgPrice: poi.biz_ext?.cost ? `äººå‡Â¥${poi.biz_ext.cost}` : "æš‚æ— ",
      openTime: poi.biz_ext?.open_time || "è¥ä¸šä¸­",
      photos: poi.photos?.slice(0, 2).map((p: any) => p.url),
      distance: poi.distance ? `${poi.distance}ç±³` : null,
    }));
    
    // æ ¹æ®ä»·æ ¼ç­‰çº§è¿‡æ»¤
    if (priceLevel) {
      const priceLevelMap: Record<string, [number, number]> = {
        budget: [0, 50],      // ç»æµå®æƒ 
        moderate: [50, 150],  // ä¸­ç­‰
        upscale: [150, 300],  // é«˜æ¡£
        luxury: [300, 9999],  // å¥¢å
      };
      const [minPrice, maxPrice] = priceLevelMap[priceLevel] || [0, 9999];
      restaurants = restaurants.filter((r: any) => {
        const price = parseInt(r.avgPrice.replace(/[^0-9]/g, "")) || 0;
        return price >= minPrice && price <= maxPrice;
      });
    }
    
    // æŒ‰è¯„åˆ†æ’åº
    restaurants.sort((a: any, b: any) => b.rating - a.rating);
    
    return JSON.stringify({
      city,
      restaurants: restaurants.slice(0, 10),
      total: restaurants.length,
      tips: "å»ºè®®æå‰æŸ¥çœ‹è¥ä¸šæ—¶é—´ï¼Œçƒ­é—¨é¤å…å¯èƒ½éœ€è¦æ’é˜Ÿ",
    });
  },
  {
    name: "search_restaurant",
    description: `æœç´¢åŸå¸‚çš„é¤å…ï¼Œæ”¯æŒæŒ‰èœç³»ã€ä»·æ ¼ç­‰çº§å’Œä½ç½®ç­›é€‰ã€‚
è¿”å›é¤å…çš„è¯„åˆ†ã€äººå‡æ¶ˆè´¹ã€è¥ä¸šæ—¶é—´ç­‰ä¿¡æ¯ã€‚
å¯ä»¥æŒ‡å®šæŸä¸ªæ™¯ç‚¹é™„è¿‘çš„é¤å…ï¼Œæ–¹ä¾¿å°±è¿‘ç”¨é¤ã€‚`,
    schema: z.object({
      city: z.string().describe("åŸå¸‚åç§°"),
      keywords: z.string().optional().describe("æœç´¢å…³é”®è¯"),
      cuisine: z.string().optional().describe("èœç³»ï¼Œå¦‚ï¼šæ­å¸®èœã€å·èœã€æ—¥æ–™ã€ç«é”…"),
      priceLevel: z.enum(["budget", "moderate", "upscale", "luxury"])
        .optional()
        .describe("ä»·æ ¼ç­‰çº§ï¼šbudget(ç»æµ)ã€moderate(ä¸­ç­‰)ã€upscale(é«˜æ¡£)ã€luxury(å¥¢å)"),
      nearLocation: z.string().optional()
        .describe("é™„è¿‘ä½ç½®çš„ç»çº¬åº¦ï¼Œæ ¼å¼ï¼šç»åº¦,çº¬åº¦ã€‚ç”¨äºæœç´¢æŸæ™¯ç‚¹é™„è¿‘çš„é¤å…"),
    }),
  }
);
```

#### 4.5.6 è·¯çº¿è§„åˆ’å·¥å…·ï¼ˆNEWï¼‰

```typescript
// src/agent/tools/route.tool.ts
import { tool } from "@langchain/core/tools";
import { z } from "zod";
import { AmapService } from "@/services/amap.service";

export const planRouteTool = tool(
  async ({ origin, destination, city, mode }) => {
    const amapService = new AmapService();
    
    // å¦‚æœè¾“å…¥çš„æ˜¯åœ°ç‚¹åç§°è€Œä¸æ˜¯ç»çº¬åº¦ï¼Œå…ˆè¿›è¡Œåœ°ç†ç¼–ç 
    let originLocation = origin;
    let destLocation = destination;
    
    if (!origin.includes(",")) {
      const geocode = await amapService.geocode(`${city}${origin}`);
      originLocation = geocode.geocodes[0]?.location || origin;
    }
    
    if (!destination.includes(",")) {
      const geocode = await amapService.geocode(`${city}${destination}`);
      destLocation = geocode.geocodes[0]?.location || destination;
    }
    
    // è°ƒç”¨è·¯çº¿è§„åˆ’ API
    const route = await amapService.planRoute({
      origin: originLocation,
      destination: destLocation,
      mode,
      city,
    });
    
    // è§£æä¸åŒäº¤é€šæ–¹å¼çš„ç»“æœ
    let routeInfo: any = {
      origin,
      destination,
      mode,
    };
    
    if (mode === "walking") {
      const path = route.route?.paths?.[0];
      routeInfo = {
        ...routeInfo,
        distance: `${(parseInt(path?.distance || "0") / 1000).toFixed(1)}å…¬é‡Œ`,
        duration: `${Math.round(parseInt(path?.duration || "0") / 60)}åˆ†é’Ÿ`,
        steps: path?.steps?.slice(0, 5).map((s: any) => s.instruction),
      };
    } else if (mode === "driving") {
      const path = route.route?.paths?.[0];
      routeInfo = {
        ...routeInfo,
        distance: `${(parseInt(path?.distance || "0") / 1000).toFixed(1)}å…¬é‡Œ`,
        duration: `${Math.round(parseInt(path?.duration || "0") / 60)}åˆ†é’Ÿ`,
        taxi_cost: path?.taxi_cost ? `çº¦Â¥${path.taxi_cost}` : null,
        tolls: path?.tolls ? `è¿‡è·¯è´¹Â¥${path.tolls}` : null,
        traffic_lights: path?.traffic_lights,
      };
    } else if (mode === "transit") {
      const transits = route.route?.transits || [];
      const bestTransit = transits[0];
      routeInfo = {
        ...routeInfo,
        distance: `${(parseInt(bestTransit?.distance || "0") / 1000).toFixed(1)}å…¬é‡Œ`,
        duration: `${Math.round(parseInt(bestTransit?.duration || "0") / 60)}åˆ†é’Ÿ`,
        cost: bestTransit?.cost ? `çº¦Â¥${bestTransit.cost}` : null,
        walking_distance: `æ­¥è¡Œ${(parseInt(bestTransit?.walking_distance || "0") / 1000).toFixed(1)}å…¬é‡Œ`,
        segments: bestTransit?.segments?.slice(0, 3).map((seg: any) => {
          if (seg.bus?.buslines?.[0]) {
            const bus = seg.bus.buslines[0];
            return `ä¹˜å ${bus.name}ï¼ˆ${bus.departure_stop?.name} â†’ ${bus.arrival_stop?.name}ï¼‰`;
          }
          if (seg.walking) {
            return `æ­¥è¡Œ ${seg.walking.distance}ç±³`;
          }
          return null;
        }).filter(Boolean),
        alternatives: transits.slice(1, 3).map((t: any) => ({
          duration: `${Math.round(parseInt(t.duration || "0") / 60)}åˆ†é’Ÿ`,
          cost: t.cost ? `Â¥${t.cost}` : null,
        })),
      };
    }
    
    return JSON.stringify(routeInfo);
  },
  {
    name: "plan_route",
    description: `è§„åˆ’ä¸¤ä¸ªåœ°ç‚¹ä¹‹é—´çš„è·¯çº¿ï¼Œæ”¯æŒæ­¥è¡Œã€é©¾è½¦ã€å…¬å…±äº¤é€šä¸‰ç§æ–¹å¼ã€‚
è¿”å›è·ç¦»ã€é¢„è®¡æ—¶é—´ã€è´¹ç”¨ç­‰ä¿¡æ¯ã€‚
ç”¨äºè®¡ç®—æ™¯ç‚¹ä¹‹é—´çš„äº¤é€šæ—¶é—´ï¼Œä¼˜åŒ–è¡Œç¨‹å®‰æ’ã€‚`,
    schema: z.object({
      origin: z.string().describe("èµ·ç‚¹åç§°æˆ–ç»çº¬åº¦ï¼ˆæ ¼å¼ï¼šç»åº¦,çº¬åº¦ï¼‰"),
      destination: z.string().describe("ç»ˆç‚¹åç§°æˆ–ç»çº¬åº¦"),
      city: z.string().describe("åŸå¸‚åç§°ï¼Œç”¨äºåœ°ç†ç¼–ç "),
      mode: z.enum(["walking", "driving", "transit"])
        .default("transit")
        .describe("äº¤é€šæ–¹å¼ï¼šwalking(æ­¥è¡Œ)ã€driving(é©¾è½¦)ã€transit(å…¬å…±äº¤é€š)"),
    }),
  }
);
```

#### 4.5.7 é€šç”¨ POI æœç´¢å·¥å…·

```typescript
// src/agent/tools/poi.tool.ts
import { tool } from "@langchain/core/tools";
import { z } from "zod";
import { AmapService } from "@/services/amap.service";

export const searchPOITool = tool(
  async ({ city, type, keywords }) => {
    const amapService = new AmapService();
    
    // POI ç±»å‹æ˜ å°„
    const typeMapping: Record<string, string> = {
      attraction: "110000", // é£æ™¯åèƒœ
      restaurant: "050000", // é¤é¥®æœåŠ¡
      shopping: "060000",   // è´­ç‰©æœåŠ¡
      entertainment: "080000", // å¨±ä¹
    };
    
    const pois = await amapService.searchPOI({
      keywords: keywords || "",
      city,
      types: typeMapping[type] || "",
      page_size: 20,
    });
    
    const result = (pois.pois || []).map((poi: any) => ({
      id: poi.id,
      name: poi.name,
      type: poi.type,
      typecode: poi.typecode,
      address: poi.address,
      location: poi.location,
      tel: poi.tel,
      rating: poi.biz_ext?.rating,
      cost: poi.biz_ext?.cost,
      openTime: poi.biz_ext?.open_time,
      photos: poi.photos?.slice(0, 3).map((p: any) => p.url),
    }));
    
    return JSON.stringify({
      city,
      type,
      pois: result,
      total: pois.count,
    });
  },
  {
    name: "search_poi",
    description: "æœç´¢æ™¯ç‚¹ã€é¤å…ã€è´­ç‰©ä¸­å¿ƒç­‰å…´è¶£ç‚¹",
    schema: z.object({
      city: z.string().describe("åŸå¸‚åç§°"),
      type: z.enum(["attraction", "restaurant", "shopping", "entertainment"])
        .describe("POIç±»å‹ï¼šattraction(æ™¯ç‚¹)ã€restaurant(é¤å…)ã€shopping(è´­ç‰©)ã€entertainment(å¨±ä¹)"),
      keywords: z.string().optional().describe("æœç´¢å…³é”®è¯"),
    }),
  }
);
```

#### 4.5.8 è·å–å½“å‰æ—¥æœŸå·¥å…·

```typescript
// src/agent/tools/date.tool.ts
import { tool } from "@langchain/core/tools";
import { z } from "zod";

export const getCurrentDateTool = tool(
  async () => {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, "0");
    const day = String(now.getDate()).padStart(2, "0");
    const weekDay = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"][now.getDay()];
    
    return JSON.stringify({
      date: `${year}-${month}-${day}`,
      year,
      month: now.getMonth() + 1,
      day: now.getDate(),
      weekDay: `æ˜ŸæœŸ${weekDay}`,
      timestamp: now.getTime(),
    });
  },
  {
    name: "get_current_date",
    description: "è·å–å½“å‰æ—¥æœŸï¼Œç”¨äºè®¡ç®—å‡ºè¡Œæ—¥æœŸ",
    schema: z.object({}),
  }
);
```

### 4.6 å¤š Agent å®ç°

#### 4.6.1 Agent ç³»ç»Ÿæ•´ä½“ç»“æ„

```typescript
// src/agent/index.ts
import { StateGraph, Annotation, END, START } from "@langchain/langgraph";
import { BaseMessage, HumanMessage, AIMessage } from "@langchain/core/messages";
import { ChatOpenAI } from "@langchain/openai";
import { MemorySaver } from "@langchain/langgraph";

// å®šä¹‰çŠ¶æ€
const TravelPlannerState = Annotation.Root({
  messages: Annotation<BaseMessage[]>({
    reducer: (prev, next) => [...prev, ...next],
    default: () => [],
  }),
  intent: Annotation<string>(),
  params: Annotation<{
    destination?: string;
    days?: number;
    budget?: number;
    startDate?: string;
    travelers?: number;
    preferences?: string[];
  }>(),
  collectedInfo: Annotation<{
    weather?: any;
    transport?: any;
    hotels?: any[];
    attractions?: any[];
    restaurants?: any[];
    routes?: any[];
  }>(),
  tripPlan: Annotation<any>(),
  currentTripId: Annotation<string>(),
});

export type TravelPlannerStateType = typeof TravelPlannerState.State;
```

#### 4.6.2 Coordinator Agentï¼ˆåè°ƒå™¨ï¼‰

```typescript
// src/agent/coordinator.agent.ts
import { ChatOpenAI } from "@langchain/openai";
import { z } from "zod";

const IntentSchema = z.object({
  intent: z.enum(["plan_trip", "query_info", "modify_trip", "general_chat"]),
  params: z.object({
    destination: z.string().optional(),
    days: z.number().optional(),
    budget: z.number().optional(),
    startDate: z.string().optional(),
    travelers: z.number().optional(),
    preferences: z.array(z.string()).optional(),
  }),
  reasoning: z.string(),
});

const COORDINATOR_PROMPT = `ä½ æ˜¯æ—…æ¸¸è§„åˆ’åè°ƒå‘˜ï¼Œè´Ÿè´£ç†è§£ç”¨æˆ·æ„å›¾å¹¶æå–å…³é”®ä¿¡æ¯ã€‚

## æ„å›¾ç±»å‹
- plan_trip: ç”¨æˆ·æƒ³è§„åˆ’æ–°è¡Œç¨‹ï¼ˆ"æˆ‘æƒ³å»æ­å·ç©"ã€"å¸®æˆ‘è§„åˆ’ä¸€ä¸ªåŒ—äº¬5æ—¥æ¸¸"ï¼‰
- query_info: ç”¨æˆ·åªæ˜¯æŸ¥è¯¢ä¿¡æ¯ï¼ˆ"æ­å·å¤©æ°”"ã€"ç«è½¦ç¥¨å¤šå°‘é’±"ï¼‰
- modify_trip: ç”¨æˆ·æƒ³ä¿®æ”¹å·²æœ‰è¡Œç¨‹ï¼ˆ"æŠŠè¥¿æ¹–æ¢æˆçµéšå¯º"ã€"å¢åŠ ä¸€å¤©"ï¼‰
- general_chat: é—²èŠï¼ˆ"ä½ å¥½"ã€"è°¢è°¢"ï¼‰

## å‚æ•°æå–
ä»”ç»†åˆ†æç”¨æˆ·æ¶ˆæ¯ï¼Œæå–ä»¥ä¸‹ä¿¡æ¯ï¼š
- destination: ç›®çš„åœ°åŸå¸‚
- days: æ—…è¡Œå¤©æ•°
- budget: é¢„ç®—é‡‘é¢
- startDate: å‡ºå‘æ—¥æœŸ
- travelers: å‡ºè¡Œäººæ•°
- preferences: åå¥½æ ‡ç­¾ï¼ˆè‡ªç„¶é£æ™¯ã€å†å²æ–‡åŒ–ã€ç¾é£Ÿã€äº²å­ç­‰ï¼‰

å¦‚æœç”¨æˆ·è¯´"ä¸‹å‘¨æœ«"ã€"äº”ä¸€"ç­‰ï¼Œè®¾ç½® startDate ä¸ºç›¸å¯¹æè¿°ï¼Œåç»­ä¼šè®¡ç®—å…·ä½“æ—¥æœŸã€‚
å¦‚æœä¿¡æ¯ä¸å®Œæ•´ï¼Œè®¾ç½®ä¸º nullï¼Œåç»­å¯ä»¥è¿½é—®ã€‚`;

export async function coordinatorAgent(state: TravelPlannerStateType) {
  const model = new ChatOpenAI({
    model: "gpt-4o",
    temperature: 0,
  }).withStructuredOutput(IntentSchema);

  const lastMessage = state.messages[state.messages.length - 1];
  
  const result = await model.invoke([
    { role: "system", content: COORDINATOR_PROMPT },
    { role: "user", content: lastMessage.content as string },
  ]);

  return {
    intent: result.intent,
    params: result.params,
    messages: [new AIMessage({
      content: `[æ„å›¾è¯†åˆ«] ${result.intent}: ${result.reasoning}`,
    })],
  };
}

// è·¯ç”±å‡½æ•°
export function routeByIntent(state: TravelPlannerStateType): string {
  switch (state.intent) {
    case "plan_trip":
      return "info_collector";
    case "query_info":
      return "info_collector";
    case "modify_trip":
      return "trip_adjuster";
    case "general_chat":
    default:
      return "responder";
  }
}
```

#### 4.6.3 Info Collector Sub-Agentï¼ˆä¿¡æ¯æ”¶é›†å™¨ï¼‰

```typescript
// src/agent/info-collector.agent.ts
import { createReactAgent } from "@langchain/langgraph/prebuilt";
import { ChatOpenAI } from "@langchain/openai";
import { SystemMessage } from "@langchain/core/messages";

import { getWeatherTool } from "./tools/weather.tool";
import { searchTrainTool } from "./tools/transport.tool";
import { searchHotelTool } from "./tools/hotel.tool";
import { searchAttractionTool } from "./tools/attraction.tool";
import { searchRestaurantTool } from "./tools/restaurant.tool";
import { planRouteTool } from "./tools/route.tool";
import { getCurrentDateTool } from "./tools/date.tool";

const INFO_COLLECTOR_PROMPT = `ä½ æ˜¯ä¿¡æ¯æ”¶é›†ä¸“å®¶ï¼Œè´Ÿè´£æ”¶é›†æ—…è¡Œè§„åˆ’æ‰€éœ€çš„å„ç±»ä¿¡æ¯ã€‚

## ä½ çš„å·¥å…·
1. get_weather - æŸ¥è¯¢å¤©æ°”é¢„æŠ¥
2. search_train - æŸ¥è¯¢ç«è½¦ç¥¨
3. search_hotel - æœç´¢é…’åº—
4. search_attraction - æœç´¢æ™¯ç‚¹
5. search_restaurant - æœç´¢é¤å…
6. plan_route - è§„åˆ’è·¯çº¿
7. get_current_date - è·å–å½“å‰æ—¥æœŸ

## å·¥ä½œåŸåˆ™
1. **å¹¶è¡Œè°ƒç”¨**ï¼šå°½å¯èƒ½åŒæ—¶è°ƒç”¨å¤šä¸ªå·¥å…·ï¼Œæé«˜æ•ˆç‡
2. **å…¨é¢æ”¶é›†**ï¼šå¤©æ°”ã€äº¤é€šã€ä½å®¿ã€æ™¯ç‚¹ã€é¤å…éƒ½è¦æ”¶é›†
3. **æ™ºèƒ½ç­›é€‰**ï¼šæ ¹æ®é¢„ç®—ç­›é€‰åˆé€‚çš„é…’åº—å’Œé¤å…
4. **è·¯çº¿é¢„è§„åˆ’**ï¼šæ”¶é›†ä¸»è¦æ™¯ç‚¹ä¹‹é—´çš„è·¯çº¿ä¿¡æ¯

## æ”¶é›†é¡ºåº
1. å…ˆè·å–å½“å‰æ—¥æœŸï¼ˆå¦‚æœç”¨æˆ·è¯´äº†ç›¸å¯¹æ—¥æœŸï¼‰
2. å¹¶è¡ŒæŸ¥è¯¢ï¼šå¤©æ°”ã€ç«è½¦ç¥¨ã€é…’åº—
3. å†å¹¶è¡ŒæŸ¥è¯¢ï¼šæ™¯ç‚¹ã€é¤å…
4. æœ€åè§„åˆ’ä¸»è¦æ™¯ç‚¹é—´çš„è·¯çº¿

æ”¶é›†å®Œæˆåï¼Œæ•´ç†æˆç»“æ„åŒ–çš„ä¿¡æ¯æ‘˜è¦è¿”å›ã€‚`;

export function createInfoCollectorAgent() {
  const model = new ChatOpenAI({
    model: "gpt-4o",
    temperature: 0.3,
  });

  const tools = [
    getWeatherTool,
    searchTrainTool,
    searchHotelTool,
    searchAttractionTool,
    searchRestaurantTool,
    planRouteTool,
    getCurrentDateTool,
  ];

  return createReactAgent({
    llm: model,
    tools,
    messageModifier: new SystemMessage(INFO_COLLECTOR_PROMPT),
  });
}

export async function infoCollectorNode(state: TravelPlannerStateType) {
  const agent = createInfoCollectorAgent();
  
  // æ„å»ºæ”¶é›†ä¿¡æ¯çš„æŒ‡ä»¤
  const { destination, days, budget, startDate } = state.params;
  const instruction = `
è¯·ä¸ºä»¥ä¸‹æ—…è¡Œæ”¶é›†ä¿¡æ¯ï¼š
- ç›®çš„åœ°ï¼š${destination}
- å¤©æ•°ï¼š${days}å¤©
- é¢„ç®—ï¼š${budget}å…ƒ
- å‡ºå‘æ—¥æœŸï¼š${startDate || "å¾…å®š"}

è¯·å¹¶è¡Œè°ƒç”¨å·¥å…·æ”¶é›†ï¼š
1. å¤©æ°”é¢„æŠ¥ï¼ˆ${days}å¤©ï¼‰
2. ç«è½¦ç¥¨ä¿¡æ¯
3. é…’åº—æ¨èï¼ˆç¬¦åˆé¢„ç®—ï¼‰
4. çƒ­é—¨æ™¯ç‚¹
5. ç‰¹è‰²é¤å…
6. ä¸»è¦æ™¯ç‚¹é—´çš„è·¯çº¿
`;

  const result = await agent.invoke({
    messages: [{ role: "user", content: instruction }],
  });

  // è§£ææ”¶é›†åˆ°çš„ä¿¡æ¯
  const collectedInfo = parseCollectedInfo(result.messages);

  return {
    collectedInfo,
    messages: result.messages,
  };
}

function parseCollectedInfo(messages: any[]) {
  // ä» tool messages ä¸­è§£ææ”¶é›†åˆ°çš„ä¿¡æ¯
  const info: any = {
    weather: null,
    transport: null,
    hotels: [],
    attractions: [],
    restaurants: [],
    routes: [],
  };

  for (const msg of messages) {
    if (msg._getType() === "tool") {
      try {
        const content = JSON.parse(msg.content);
        if (content.city && content.current) {
          info.weather = content;
        } else if (content.tickets) {
          info.transport = content;
        } else if (content.hotels) {
          info.hotels = content.hotels;
        } else if (content.attractions) {
          info.attractions = content.attractions;
        } else if (content.restaurants) {
          info.restaurants = content.restaurants;
        } else if (content.origin && content.destination) {
          info.routes.push(content);
        }
      } catch (e) {
        // å¿½ç•¥è§£æé”™è¯¯
      }
    }
  }

  return info;
}
```

#### 4.6.4 Trip Planner Sub-Agentï¼ˆè¡Œç¨‹è§„åˆ’å™¨ï¼‰

```typescript
// src/agent/trip-planner.agent.ts
import { ChatOpenAI } from "@langchain/openai";
import { z } from "zod";

// ç»“æ„åŒ–è¾“å‡º Schema
const TripPlanSchema = z.object({
  title: z.string().describe("è¡Œç¨‹æ ‡é¢˜ï¼Œå¦‚ï¼šæ­å·3æ—¥ä¼‘é—²æ¸¸"),
  destination: z.string(),
  startDate: z.string(),
  endDate: z.string(),
  totalBudget: z.number(),
  summary: z.string().describe("è¡Œç¨‹ç®€ä»‹ï¼Œ2-3å¥è¯"),
  tips: z.array(z.string()).describe("å‡ºè¡Œå°è´´å£«ï¼Œ3-5æ¡"),
  days: z.array(z.object({
    dayNumber: z.number(),
    date: z.string(),
    theme: z.string().describe("å½“å¤©ä¸»é¢˜ï¼Œå¦‚ï¼šè¥¿æ¹–ç¯çº¿æ¸¸"),
    activities: z.array(z.object({
      type: z.enum(["attraction", "restaurant", "transport", "hotel", "free"]),
      name: z.string(),
      location: z.string().optional(),
      startTime: z.string().regex(/^\d{2}:\d{2}$/),
      endTime: z.string().regex(/^\d{2}:\d{2}$/),
      duration: z.number().describe("åˆ†é’Ÿ"),
      cost: z.number(),
      notes: z.string().optional(),
      poiId: z.string().optional(),
    })),
  })),
});

const TRIP_PLANNER_PROMPT = `ä½ æ˜¯ä¸“ä¸šçš„è¡Œç¨‹è§„åˆ’å¸ˆï¼Œæ ¹æ®æ”¶é›†åˆ°çš„ä¿¡æ¯ç”Ÿæˆå®Œç¾çš„æ—…è¡Œè¡Œç¨‹ã€‚

## è§„åˆ’åŸåˆ™

### 1. æ—¶é—´å®‰æ’
- 08:00-09:00 æ—©é¤
- 09:00-12:00 ä¸Šåˆæ´»åŠ¨ï¼ˆ1-2ä¸ªæ™¯ç‚¹ï¼‰
- 12:00-13:30 åˆé¤
- 13:30-14:00 ä¼‘æ¯/ç§»åŠ¨
- 14:00-17:30 ä¸‹åˆæ´»åŠ¨ï¼ˆ1-2ä¸ªæ™¯ç‚¹ï¼‰
- 18:00-19:30 æ™šé¤
- 19:30-21:00 å¤œé—´æ´»åŠ¨ï¼ˆå¯é€‰ï¼‰

### 2. æ™¯ç‚¹å®‰æ’
- åœ°ç†ä½ç½®ç›¸è¿‘çš„æ™¯ç‚¹æ”¾åŒä¸€å¤©
- è€ƒè™‘æ™¯ç‚¹å¼€æ”¾æ—¶é—´
- å®¤å¤–æ™¯ç‚¹çœ‹å¤©æ°”å®‰æ’
- çƒ­é—¨æ™¯ç‚¹å°½é‡å®‰æ’åœ¨å·¥ä½œæ—¥

### 3. é¤é¥®å®‰æ’
- é€‰æ‹©æ™¯ç‚¹é™„è¿‘çš„é¤å…
- åˆé¤å¯ä»¥ç®€å•ï¼Œæ™šé¤å¯ä»¥ä¸°å¯Œ
- æ ¹æ®é¢„ç®—é€‰æ‹©é¤å…æ¡£æ¬¡

### 4. äº¤é€šæ—¶é—´
- æ™¯ç‚¹ä¹‹é—´é¢„ç•™äº¤é€šæ—¶é—´
- ä½¿ç”¨æ”¶é›†åˆ°çš„è·¯çº¿ä¿¡æ¯ä¼°ç®—
- é«˜å³°æœŸé€‚å½“å¢åŠ æ—¶é—´

### 5. é¢„ç®—æ§åˆ¶
- å…ˆç®—å¿…è¦æ”¯å‡ºï¼ˆäº¤é€šã€ä½å®¿ï¼‰
- å†åˆ†é…æ™¯ç‚¹é—¨ç¥¨
- å‰©ä½™ç”¨äºé¤é¥®

## è¾“å‡ºè¦æ±‚
ç”Ÿæˆç»“æ„åŒ–çš„è¡Œç¨‹ JSONï¼Œæ¯ä¸ªæ´»åŠ¨éƒ½è¦æœ‰ï¼š
- ç²¾ç¡®çš„å¼€å§‹å’Œç»“æŸæ—¶é—´
- é¢„ä¼°è´¹ç”¨
- å¿…è¦çš„å¤‡æ³¨`;

export async function tripPlannerNode(state: TravelPlannerStateType) {
  const model = new ChatOpenAI({
    model: "gpt-4o",
    temperature: 0.7,
  }).withStructuredOutput(TripPlanSchema);

  const { destination, days, budget, startDate, preferences } = state.params;
  const { weather, transport, hotels, attractions, restaurants, routes } = state.collectedInfo;

  const prompt = `
## æ—…è¡Œéœ€æ±‚
- ç›®çš„åœ°ï¼š${destination}
- å¤©æ•°ï¼š${days}å¤©
- é¢„ç®—ï¼š${budget}å…ƒ
- å‡ºå‘æ—¥æœŸï¼š${startDate}
- åå¥½ï¼š${preferences?.join("ã€") || "æ— ç‰¹æ®Šåå¥½"}

## æ”¶é›†åˆ°çš„ä¿¡æ¯

### å¤©æ°”é¢„æŠ¥
${JSON.stringify(weather, null, 2)}

### äº¤é€šä¿¡æ¯
${JSON.stringify(transport, null, 2)}

### é…’åº—æ¨è
${JSON.stringify(hotels?.slice(0, 5), null, 2)}

### çƒ­é—¨æ™¯ç‚¹
${JSON.stringify(attractions?.slice(0, 15), null, 2)}

### ç‰¹è‰²é¤å…
${JSON.stringify(restaurants?.slice(0, 10), null, 2)}

### è·¯çº¿ä¿¡æ¯
${JSON.stringify(routes, null, 2)}

è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä¸ªåˆç†çš„ ${days} å¤©è¡Œç¨‹å®‰æ’ã€‚
`;

  const tripPlan = await model.invoke([
    { role: "system", content: TRIP_PLANNER_PROMPT },
    { role: "user", content: prompt },
  ]);

  return {
    tripPlan,
    messages: [new AIMessage({
      content: `è¡Œç¨‹è§„åˆ’å®Œæˆï¼${tripPlan.title}\n\n${tripPlan.summary}`,
    })],
  };
}

export { TripPlanSchema };
```

#### 4.6.5 Trip Adjuster Sub-Agentï¼ˆè¡Œç¨‹è°ƒæ•´å™¨ï¼‰

```typescript
// src/agent/trip-adjuster.agent.ts
import { createReactAgent } from "@langchain/langgraph/prebuilt";
import { ChatOpenAI } from "@langchain/openai";
import { SystemMessage } from "@langchain/core/messages";

import { searchAttractionTool } from "./tools/attraction.tool";
import { searchRestaurantTool } from "./tools/restaurant.tool";
import { planRouteTool } from "./tools/route.tool";

const TRIP_ADJUSTER_PROMPT = `ä½ æ˜¯è¡Œç¨‹è°ƒæ•´ä¸“å®¶ï¼Œè´Ÿè´£æ ¹æ®ç”¨æˆ·åé¦ˆä¿®æ”¹å·²æœ‰è¡Œç¨‹ã€‚

## ä½ çš„èƒ½åŠ›
1. ç†è§£ç”¨æˆ·çš„ä¿®æ”¹æ„å›¾
2. æœç´¢æ–°çš„æ™¯ç‚¹/é¤å…ä¿¡æ¯
3. é‡æ–°è§„åˆ’è·¯çº¿
4. è°ƒæ•´æ—¶é—´å®‰æ’é¿å…å†²çª

## ä¿®æ”¹ç±»å‹
1. **æ›¿æ¢**ï¼š"æŠŠ X æ¢æˆ Y"
   - æ‰¾åˆ° X åœ¨è¡Œç¨‹ä¸­çš„ä½ç½®
   - æœç´¢ Y çš„ä¿¡æ¯
   - ç”¨ Y æ›¿æ¢ X
   - è°ƒæ•´å‰åæ—¶é—´

2. **å¢åŠ **ï¼š"å¢åŠ  X" / "æƒ³å» X"
   - æœç´¢ X çš„ä¿¡æ¯
   - æ‰¾åˆ°åˆé€‚çš„æ—¶é—´æ®µæ’å…¥
   - è°ƒæ•´åç»­æ´»åŠ¨æ—¶é—´

3. **åˆ é™¤**ï¼š"ä¸æƒ³å» X" / "å»æ‰ X"
   - æ‰¾åˆ° X åœ¨è¡Œç¨‹ä¸­çš„ä½ç½®
   - åˆ é™¤ X
   - é‡æ–°åˆ†é…é‡Šæ”¾çš„æ—¶é—´

4. **è°ƒæ•´é¡ºåº**ï¼š"X æ”¾åˆ°ç¬¬ N å¤©"
   - ç§»åŠ¨ X åˆ°ç›®æ ‡ä½ç½®
   - é‡æ–°ä¼˜åŒ–è·¯çº¿

## æ³¨æ„äº‹é¡¹
- ä¿®æ”¹åæ£€æŸ¥æ—¶é—´å†²çª
- æ›´æ–°å½“å¤©çš„è·¯çº¿è§„åˆ’
- é‡æ–°è®¡ç®—è´¹ç”¨ä¼°ç®—
- ç»™å‡ºä¿®æ”¹è¯´æ˜`;

export function createTripAdjusterAgent() {
  const model = new ChatOpenAI({
    model: "gpt-4o",
    temperature: 0.3,
  });

  const tools = [
    searchAttractionTool,
    searchRestaurantTool,
    planRouteTool,
  ];

  return createReactAgent({
    llm: model,
    tools,
    messageModifier: new SystemMessage(TRIP_ADJUSTER_PROMPT),
  });
}

export async function tripAdjusterNode(state: TravelPlannerStateType) {
  const agent = createTripAdjusterAgent();
  
  const lastMessage = state.messages[state.messages.length - 1];
  const currentTrip = state.tripPlan;

  const instruction = `
å½“å‰è¡Œç¨‹ï¼š
${JSON.stringify(currentTrip, null, 2)}

ç”¨æˆ·è¯·æ±‚ï¼š
${lastMessage.content}

è¯·æ ¹æ®ç”¨æˆ·è¯·æ±‚ä¿®æ”¹è¡Œç¨‹ï¼Œå¹¶è¿”å›ä¿®æ”¹åçš„å®Œæ•´è¡Œç¨‹ã€‚
`;

  const result = await agent.invoke({
    messages: [{ role: "user", content: instruction }],
  });

  // è§£æä¿®æ”¹åçš„è¡Œç¨‹
  const updatedTripPlan = parseUpdatedTrip(result.messages, currentTrip);

  return {
    tripPlan: updatedTripPlan,
    messages: result.messages,
  };
}

function parseUpdatedTrip(messages: any[], currentTrip: any) {
  // ä» AI å›å¤ä¸­è§£ææ›´æ–°åçš„è¡Œç¨‹
  // å®é™…å®ç°ä¸­éœ€è¦æ›´å¤æ‚çš„è§£æé€»è¾‘
  return currentTrip; // ç®€åŒ–ç¤ºä¾‹
}
```

#### 4.6.6 ç»„è£…å®Œæ•´çš„ Graph

```typescript
// src/agent/travel-planner.graph.ts
import { StateGraph, END, START } from "@langchain/langgraph";
import { MemorySaver } from "@langchain/langgraph";

import { TravelPlannerState } from "./index";
import { coordinatorAgent, routeByIntent } from "./coordinator.agent";
import { infoCollectorNode } from "./info-collector.agent";
import { tripPlannerNode } from "./trip-planner.agent";
import { tripAdjusterNode } from "./trip-adjuster.agent";

// å›å¤èŠ‚ç‚¹ï¼ˆç”¨äºé—²èŠï¼‰
async function responderNode(state: typeof TravelPlannerState.State) {
  return {
    messages: [new AIMessage({
      content: "ä½ å¥½ï¼æˆ‘æ˜¯AIæ—…æ¸¸è§„åˆ’å¸ˆï¼Œå‘Šè¯‰æˆ‘ä½ æƒ³å»å“ªé‡Œç©ï¼Œæˆ‘æ¥å¸®ä½ è§„åˆ’å®Œç¾çš„è¡Œç¨‹ï¼ğŸŒ´",
    })],
  };
}

// æœ€ç»ˆå“åº”èŠ‚ç‚¹
async function finalResponseNode(state: typeof TravelPlannerState.State) {
  const tripPlan = state.tripPlan;
  
  if (!tripPlan) {
    return { messages: [] };
  }

  // ç”Ÿæˆå‹å¥½çš„è¡Œç¨‹æè¿°
  const response = formatTripResponse(tripPlan);
  
  return {
    messages: [new AIMessage({ content: response })],
  };
}

function formatTripResponse(tripPlan: any): string {
  let response = `## ğŸ‰ ${tripPlan.title}\n\n`;
  response += `${tripPlan.summary}\n\n`;
  
  for (const day of tripPlan.days) {
    response += `### Day ${day.dayNumber}: ${day.theme}\n`;
    for (const activity of day.activities) {
      const emoji = getActivityEmoji(activity.type);
      response += `- ${emoji} **${activity.startTime}-${activity.endTime}** ${activity.name}`;
      if (activity.cost > 0) {
        response += ` (Â¥${activity.cost})`;
      }
      response += "\n";
    }
    response += "\n";
  }
  
  response += `### ğŸ’¡ å°è´´å£«\n`;
  for (const tip of tripPlan.tips) {
    response += `- ${tip}\n`;
  }
  
  response += `\n**é¢„ä¼°æ€»è´¹ç”¨ï¼šÂ¥${tripPlan.totalBudget}**`;
  
  return response;
}

function getActivityEmoji(type: string): string {
  const emojiMap: Record<string, string> = {
    attraction: "ğŸï¸",
    restaurant: "ğŸœ",
    transport: "ğŸš„",
    hotel: "ğŸ¨",
    free: "â˜•",
  };
  return emojiMap[type] || "ğŸ“";
}

// æ„å»º Graph
export function createTravelPlannerGraph() {
  const workflow = new StateGraph(TravelPlannerState)
    // æ·»åŠ èŠ‚ç‚¹
    .addNode("coordinator", coordinatorAgent)
    .addNode("info_collector", infoCollectorNode)
    .addNode("trip_planner", tripPlannerNode)
    .addNode("trip_adjuster", tripAdjusterNode)
    .addNode("responder", responderNode)
    .addNode("final_response", finalResponseNode)
    
    // æ·»åŠ è¾¹
    .addEdge(START, "coordinator")
    .addConditionalEdges("coordinator", routeByIntent)
    .addEdge("info_collector", "trip_planner")
    .addEdge("trip_planner", "final_response")
    .addEdge("trip_adjuster", "final_response")
    .addEdge("responder", END)
    .addEdge("final_response", END);

  // æ·»åŠ  checkpointer æ”¯æŒå¤šè½®å¯¹è¯
  const checkpointer = new MemorySaver();
  
  return workflow.compile({ checkpointer });
}

// å¯¼å‡ºæµå¼è°ƒç”¨æ–¹æ³•
export async function* streamTravelPlanner(
  message: string,
  threadId: string
) {
  const graph = createTravelPlannerGraph();
  
  const config = {
    configurable: { thread_id: threadId },
    streamMode: "messages" as const,
  };

  const stream = await graph.stream(
    { messages: [new HumanMessage(message)] },
    config
  );

  for await (const event of stream) {
    yield event;
  }
}
```

### 4.4 Agent Service å°è£…

```typescript
// src/services/agent.service.ts
import { createTravelPlannerAgent, streamTravelPlanner } from "@/agent/travel-planner.agent";
import { PrismaClient } from "@prisma/client";
import { AIMessage, HumanMessage, ToolMessage } from "@langchain/core/messages";
import { TripPlanSchema } from "@/agent/tools/trip.tool";

const prisma = new PrismaClient();

export class AgentService {
  private agent = createTravelPlannerAgent();

  async *chat(conversationId: string, userMessage: string) {
    // 1. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
    await prisma.message.create({
      data: {
        conversationId,
        role: "user",
        content: userMessage,
      },
    });

    // 2. æµå¼è°ƒç”¨ Agent
    let fullContent = "";
    let toolCalls: any[] = [];
    let generatedTrip: any = null;

    const stream = streamTravelPlanner(this.agent, userMessage, conversationId);

    for await (const event of stream) {
      const [messageType, messageData] = event;

      if (messageType === "messages") {
        for (const msg of messageData) {
          if (msg._getType() === "ai") {
            const aiMsg = msg as AIMessage;
            
            // å†…å®¹å¢é‡
            if (aiMsg.content) {
              const delta = typeof aiMsg.content === "string" 
                ? aiMsg.content 
                : aiMsg.content.map((c: any) => c.text || "").join("");
              fullContent += delta;
              yield { type: "content_delta", data: { content: delta } };
            }

            // å·¥å…·è°ƒç”¨
            if (aiMsg.tool_calls?.length) {
              for (const toolCall of aiMsg.tool_calls) {
                toolCalls.push(toolCall);
                yield { 
                  type: "tool_call", 
                  data: { 
                    id: toolCall.id,
                    name: toolCall.name,
                    arguments: toolCall.args,
                  } 
                };

                // å¦‚æœæ˜¯ generate_tripï¼Œè§£æè¡Œç¨‹æ•°æ®
                if (toolCall.name === "generate_trip") {
                  try {
                    generatedTrip = TripPlanSchema.parse(toolCall.args);
                  } catch (e) {
                    console.error("Failed to parse trip:", e);
                  }
                }
              }
            }
          } else if (msg._getType() === "tool") {
            const toolMsg = msg as ToolMessage;
            yield {
              type: "tool_result",
              data: {
                toolCallId: toolMsg.tool_call_id,
                result: JSON.parse(toolMsg.content as string),
              },
            };
          }
        }
      }
    }

    // 3. ä¿å­˜ AI æ¶ˆæ¯
    await prisma.message.create({
      data: {
        conversationId,
        role: "assistant",
        content: fullContent,
        toolCalls: toolCalls.length > 0 ? toolCalls : undefined,
      },
    });

    // 4. å¦‚æœç”Ÿæˆäº†è¡Œç¨‹ï¼Œä¿å­˜åˆ°æ•°æ®åº“
    if (generatedTrip) {
      const conversation = await prisma.conversation.findUnique({
        where: { id: conversationId },
      });

      if (conversation) {
        const trip = await this.saveTripToDB(conversation.userId, conversationId, generatedTrip);
        yield { type: "trip_generated", data: { trip } };
      }
    }

    yield { type: "message_end", data: { content: fullContent } };
  }

  private async saveTripToDB(userId: string, conversationId: string, tripPlan: any) {
    return await prisma.trip.create({
      data: {
        userId,
        conversationId,
        title: tripPlan.title,
        destination: tripPlan.destination,
        startDate: new Date(tripPlan.startDate),
        endDate: new Date(tripPlan.endDate),
        budget: tripPlan.totalBudget,
        status: "draft",
        days: {
          create: tripPlan.days.map((day: any, index: number) => ({
            dayNumber: day.dayNumber || index + 1,
            date: new Date(day.date),
            activities: {
              create: day.activities.map((activity: any, actIndex: number) => ({
                type: activity.type,
                name: activity.name,
                location: activity.location,
                startTime: activity.startTime,
                endTime: activity.endTime,
                duration: activity.duration,
                cost: activity.cost,
                notes: activity.notes,
                order: actIndex,
                poiId: activity.poiId,
              })),
            },
          })),
        },
      },
      include: {
        days: {
          include: {
            activities: true,
          },
        },
      },
    });
  }
}
```

---

## äº”ã€å¤–éƒ¨ API é›†æˆ

### 5.1 é«˜å¾·åœ°å›¾ API

```typescript
// src/services/amap.service.ts
import axios from "axios";
import { config } from "@/config";
import { RedisService } from "./redis.service";

interface GeoCodeResponse {
  status: string;
  geocodes: Array<{
    location: string;
    formatted_address: string;
    adcode: string;
    city: string;
  }>;
}

interface WeatherResponse {
  status: string;
  lives: Array<{
    temperature: string;
    weather: string;
    humidity: string;
    winddirection: string;
    windpower: string;
  }>;
  forecasts: Array<{
    city: string;
    casts: Array<{
      date: string;
      week: string;
      dayweather: string;
      nightweather: string;
      daytemp: string;
      nighttemp: string;
    }>;
  }>;
}

interface POISearchResponse {
  status: string;
  count: string;
  pois: Array<{
    id: string;
    name: string;
    type: string;
    typecode: string;
    address: string;
    location: string;
    tel: string;
    distance: string;
    biz_ext?: {
      rating?: string;
      cost?: string;
      open_time?: string;
    };
    photos?: Array<{ url: string }>;
  }>;
}

export class AmapService {
  private baseUrl = "https://restapi.amap.com/v3";
  private key = config.amap.apiKey;
  private redis = new RedisService();

  async geocode(address: string): Promise<GeoCodeResponse> {
    const cacheKey = `amap:geocode:${address}`;
    const cached = await this.redis.get(cacheKey);
    if (cached) return JSON.parse(cached);

    const response = await axios.get(`${this.baseUrl}/geocode/geo`, {
      params: {
        key: this.key,
        address,
        output: "JSON",
      },
    });

    await this.redis.setEx(cacheKey, 86400, JSON.stringify(response.data)); // ç¼“å­˜24å°æ—¶
    return response.data;
  }

  async getWeather(city: string): Promise<WeatherResponse> {
    const cacheKey = `amap:weather:${city}`;
    const cached = await this.redis.get(cacheKey);
    if (cached) return JSON.parse(cached);

    // å…ˆè·å–åŸå¸‚çš„ adcode
    const geocode = await this.geocode(city);
    const adcode = geocode.geocodes[0]?.adcode;

    if (!adcode) {
      throw new Error(`æ— æ³•æ‰¾åˆ°åŸå¸‚ï¼š${city}`);
    }

    // æŸ¥è¯¢å®æ—¶å¤©æ°”
    const liveResponse = await axios.get(`${this.baseUrl}/weather/weatherInfo`, {
      params: {
        key: this.key,
        city: adcode,
        extensions: "base",
        output: "JSON",
      },
    });

    // æŸ¥è¯¢å¤©æ°”é¢„æŠ¥
    const forecastResponse = await axios.get(`${this.baseUrl}/weather/weatherInfo`, {
      params: {
        key: this.key,
        city: adcode,
        extensions: "all",
        output: "JSON",
      },
    });

    const result = {
      status: liveResponse.data.status,
      lives: liveResponse.data.lives,
      forecasts: forecastResponse.data.forecasts,
    };

    await this.redis.setEx(cacheKey, 3600, JSON.stringify(result)); // ç¼“å­˜1å°æ—¶
    return result;
  }

  async searchPOI(params: {
    keywords?: string;
    city: string;
    types?: string;
    location?: string;
    radius?: number;
    page_size?: number;
    page_num?: number;
  }): Promise<POISearchResponse> {
    const cacheKey = `amap:poi:${JSON.stringify(params)}`;
    const cached = await this.redis.get(cacheKey);
    if (cached) return JSON.parse(cached);

    const response = await axios.get(`${this.baseUrl}/place/text`, {
      params: {
        key: this.key,
        keywords: params.keywords,
        city: params.city,
        types: params.types,
        offset: params.page_size || 20,
        page: params.page_num || 1,
        extensions: "all",
        output: "JSON",
      },
    });

    await this.redis.setEx(cacheKey, 3600, JSON.stringify(response.data)); // ç¼“å­˜1å°æ—¶
    return response.data;
  }

  async searchAround(params: {
    location: string;
    keywords?: string;
    types?: string;
    radius?: number;
  }): Promise<POISearchResponse> {
    const response = await axios.get(`${this.baseUrl}/place/around`, {
      params: {
        key: this.key,
        location: params.location,
        keywords: params.keywords,
        types: params.types,
        radius: params.radius || 3000,
        extensions: "all",
        output: "JSON",
      },
    });

    return response.data;
  }

  async planRoute(params: {
    origin: string;
    destination: string;
    mode: "walking" | "driving" | "transit";
    city?: string;
  }): Promise<any> {
    const cacheKey = `amap:route:${params.mode}:${params.origin}:${params.destination}`;
    const cached = await this.redis.get(cacheKey);
    if (cached) return JSON.parse(cached);

    let endpoint = "";
    let extraParams: any = {};

    switch (params.mode) {
      case "walking":
        endpoint = "/direction/walking";
        break;
      case "driving":
        endpoint = "/direction/driving";
        extraParams = { strategy: 10 }; // æœ€å¿«è·¯çº¿
        break;
      case "transit":
        endpoint = "/direction/transit/integrated";
        extraParams = { city: params.city, cityd: params.city };
        break;
    }

    const response = await axios.get(`${this.baseUrl}${endpoint}`, {
      params: {
        key: this.key,
        origin: params.origin,
        destination: params.destination,
        output: "JSON",
        ...extraParams,
      },
    });

    await this.redis.setEx(cacheKey, 3600, JSON.stringify(response.data));
    return response.data;
  }
}
```

### 5.2 12306 ç«è½¦ç¥¨ API

```typescript
// src/services/train.service.ts
import axios from "axios";
import { RedisService } from "./redis.service";

interface StationInfo {
  code: string;
  name: string;
}

interface TrainTicket {
  trainNo: string;
  fromStation: string;
  toStation: string;
  departTime: string;
  arriveTime: string;
  duration: string;
  secondClassPrice: number;
  firstClassPrice: number;
  businessClassPrice: number;
  secondClassSeats: string;
  firstClassSeats: string;
}

export class TrainService {
  private redis = new RedisService();
  private stationMap: Map<string, string> = new Map();

  async init() {
    // åŠ è½½è½¦ç«™ä»£ç æ˜ å°„
    // å®é™…é¡¹ç›®ä¸­ä» 12306 å®˜æ–¹è·å–æˆ–ä½¿ç”¨æœ¬åœ°æ•°æ®
  }

  async getStationCode(cityName: string): Promise<string | null> {
    // åŸå¸‚åè½¬è½¦ç«™ä»£ç 
    const cacheKey = `train:station:${cityName}`;
    const cached = await this.redis.get(cacheKey);
    if (cached) return cached;

    // è°ƒç”¨ 12306 æŸ¥è¯¢æ¥å£æˆ–ä½¿ç”¨æœ¬åœ°æ˜ å°„
    // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦æ›´å®Œæ•´çš„å®ç°
    const commonStations: Record<string, string> = {
      åŒ—äº¬: "BJP",
      ä¸Šæµ·: "SHH",
      æ­å·: "HZH",
      å—äº¬: "NJH",
      å¹¿å·: "GZQ",
      æ·±åœ³: "SZQ",
      æˆéƒ½: "CDW",
      é‡åº†: "CQW",
      è¥¿å®‰: "XAY",
      æ­¦æ±‰: "WHN",
    };

    const code = commonStations[cityName];
    if (code) {
      await this.redis.setEx(cacheKey, 86400 * 30, code);
    }
    return code || null;
  }

  async searchTickets(from: string, to: string, date: string): Promise<TrainTicket[]> {
    const cacheKey = `train:tickets:${from}:${to}:${date}`;
    const cached = await this.redis.get(cacheKey);
    if (cached) return JSON.parse(cached);

    const fromCode = await this.getStationCode(from);
    const toCode = await this.getStationCode(to);

    if (!fromCode || !toCode) {
      throw new Error(`æ— æ³•æ‰¾åˆ°è½¦ç«™ï¼š${!fromCode ? from : to}`);
    }

    try {
      // è°ƒç”¨ 12306 æŸ¥è¯¢æ¥å£
      // æ³¨æ„ï¼š12306 æœ‰åçˆ¬æœºåˆ¶ï¼Œå®é™…é¡¹ç›®ä¸­éœ€è¦å¤„ç†
      // è¿™é‡Œä½¿ç”¨ç®€åŒ–çš„æ¨¡æ‹Ÿæ•°æ®
      const tickets = await this.queryFromAPI(fromCode, toCode, date);
      
      await this.redis.setEx(cacheKey, 300, JSON.stringify(tickets)); // ç¼“å­˜5åˆ†é’Ÿ
      return tickets;
    } catch (error) {
      console.error("12306 æŸ¥è¯¢å¤±è´¥:", error);
      // è¿”å›æ¨¡æ‹Ÿæ•°æ®ç”¨äºæ¼”ç¤º
      return this.getMockTickets(from, to, date);
    }
  }

  private async queryFromAPI(fromCode: string, toCode: string, date: string): Promise<TrainTicket[]> {
    // å®é™… 12306 API è°ƒç”¨
    // ç”±äº 12306 é™åˆ¶ï¼Œè¿™é‡Œè¿”å›æ¨¡æ‹Ÿæ•°æ®
    throw new Error("API not implemented");
  }

  private getMockTickets(from: string, to: string, date: string): TrainTicket[] {
    // æ¨¡æ‹Ÿæ•°æ®ç”¨äºå¼€å‘æµ‹è¯•
    return [
      {
        trainNo: "G7501",
        fromStation: from,
        toStation: to,
        departTime: "08:00",
        arriveTime: "09:30",
        duration: "1å°æ—¶30åˆ†",
        secondClassPrice: 73,
        firstClassPrice: 117,
        businessClassPrice: 219,
        secondClassSeats: "æœ‰ç¥¨",
        firstClassSeats: "æœ‰ç¥¨",
      },
      {
        trainNo: "G7503",
        fromStation: from,
        toStation: to,
        departTime: "10:00",
        arriveTime: "11:25",
        duration: "1å°æ—¶25åˆ†",
        secondClassPrice: 73,
        firstClassPrice: 117,
        businessClassPrice: 219,
        secondClassSeats: "æœ‰ç¥¨",
        firstClassSeats: "3å¼ ",
      },
      {
        trainNo: "D3101",
        fromStation: from,
        toStation: to,
        departTime: "12:30",
        arriveTime: "14:20",
        duration: "1å°æ—¶50åˆ†",
        secondClassPrice: 56,
        firstClassPrice: 89,
        businessClassPrice: 0,
        secondClassSeats: "æœ‰ç¥¨",
        firstClassSeats: "æœ‰ç¥¨",
      },
    ];
  }
}
```

### 5.3 Redis æœåŠ¡

```typescript
// src/services/redis.service.ts
import { createClient, RedisClientType } from "redis";
import { config } from "@/config";
import { logger } from "@/utils/logger";

export class RedisService {
  private client: RedisClientType | null = null;
  private memoryCache: Map<string, { value: string; expireAt: number }> = new Map();
  private isConnected = false;

  async connect() {
    if (this.isConnected) return;

    try {
      this.client = createClient({
        url: config.redis.url,
      });

      this.client.on("error", (err) => {
        logger.error("Redis è¿æ¥é”™è¯¯:", err);
        this.isConnected = false;
      });

      await this.client.connect();
      this.isConnected = true;
      logger.info("Redis è¿æ¥æˆåŠŸ");
    } catch (error) {
      logger.warn("Redis è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨å†…å­˜ç¼“å­˜:", error);
      this.isConnected = false;
    }
  }

  async get(key: string): Promise<string | null> {
    if (this.isConnected && this.client) {
      try {
        return await this.client.get(key);
      } catch (error) {
        logger.error("Redis get é”™è¯¯:", error);
      }
    }

    // é™çº§åˆ°å†…å­˜ç¼“å­˜
    const cached = this.memoryCache.get(key);
    if (cached && cached.expireAt > Date.now()) {
      return cached.value;
    }
    this.memoryCache.delete(key);
    return null;
  }

  async setEx(key: string, seconds: number, value: string): Promise<void> {
    if (this.isConnected && this.client) {
      try {
        await this.client.setEx(key, seconds, value);
        return;
      } catch (error) {
        logger.error("Redis setEx é”™è¯¯:", error);
      }
    }

    // é™çº§åˆ°å†…å­˜ç¼“å­˜
    this.memoryCache.set(key, {
      value,
      expireAt: Date.now() + seconds * 1000,
    });
  }

  async del(key: string): Promise<void> {
    if (this.isConnected && this.client) {
      try {
        await this.client.del(key);
      } catch (error) {
        logger.error("Redis del é”™è¯¯:", error);
      }
    }
    this.memoryCache.delete(key);
  }

  async disconnect() {
    if (this.client) {
      await this.client.disconnect();
      this.isConnected = false;
    }
  }
}
```

---

## å…­ã€åç«¯é¡¹ç›®ç»“æ„

```
travel-planner-backend/
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma              # æ•°æ®åº“æ¨¡å‹å®šä¹‰
â”‚   â””â”€â”€ migrations/                # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ agent/                     # LangChain Multi-Agent ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ tools/                 # å·¥å…·å®šä¹‰ï¼ˆ8ä¸ªå·¥å…·ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ weather.tool.ts    # å¤©æ°”æŸ¥è¯¢
â”‚   â”‚   â”‚   â”œâ”€â”€ transport.tool.ts  # ç«è½¦ç¥¨æŸ¥è¯¢
â”‚   â”‚   â”‚   â”œâ”€â”€ hotel.tool.ts      # é…’åº—æœç´¢
â”‚   â”‚   â”‚   â”œâ”€â”€ attraction.tool.ts # æ™¯ç‚¹æœç´¢ â­
â”‚   â”‚   â”‚   â”œâ”€â”€ restaurant.tool.ts # é¤å…æœç´¢ â­
â”‚   â”‚   â”‚   â”œâ”€â”€ route.tool.ts      # è·¯çº¿è§„åˆ’ â­
â”‚   â”‚   â”‚   â”œâ”€â”€ poi.tool.ts        # é€šç”¨ POI æœç´¢
â”‚   â”‚   â”‚   â”œâ”€â”€ date.tool.ts       # æ—¥æœŸè·å–
â”‚   â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ coordinator.agent.ts   # åè°ƒå™¨ Agent â­
â”‚   â”‚   â”œâ”€â”€ info-collector.agent.ts # ä¿¡æ¯æ”¶é›† Sub-Agent â­
â”‚   â”‚   â”œâ”€â”€ trip-planner.agent.ts  # è¡Œç¨‹è§„åˆ’ Sub-Agent â­
â”‚   â”‚   â”œâ”€â”€ trip-adjuster.agent.ts # è¡Œç¨‹è°ƒæ•´ Sub-Agent â­
â”‚   â”‚   â”œâ”€â”€ travel-planner.graph.ts # å®Œæ•´ Graph ç»„è£… â­
â”‚   â”‚   â””â”€â”€ index.ts               # çŠ¶æ€å®šä¹‰
â”‚   â”œâ”€â”€ config/                    # é…ç½®
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ controllers/               # æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”‚   â”œâ”€â”€ chat.controller.ts
â”‚   â”‚   â”œâ”€â”€ conversation.controller.ts
â”‚   â”‚   â””â”€â”€ trip.controller.ts
â”‚   â”œâ”€â”€ middlewares/               # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ auth.middleware.ts
â”‚   â”‚   â”œâ”€â”€ error.middleware.ts
â”‚   â”‚   â””â”€â”€ validate.middleware.ts
â”‚   â”œâ”€â”€ routes/                    # è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ auth.routes.ts
â”‚   â”‚   â”œâ”€â”€ chat.routes.ts
â”‚   â”‚   â”œâ”€â”€ conversation.routes.ts
â”‚   â”‚   â”œâ”€â”€ trip.routes.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ services/                  # æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ agent.service.ts
â”‚   â”‚   â”œâ”€â”€ amap.service.ts
â”‚   â”‚   â”œâ”€â”€ auth.service.ts
â”‚   â”‚   â”œâ”€â”€ conversation.service.ts
â”‚   â”‚   â”œâ”€â”€ redis.service.ts
â”‚   â”‚   â”œâ”€â”€ train.service.ts
â”‚   â”‚   â”œâ”€â”€ trip.service.ts
â”‚   â”‚   â””â”€â”€ user.service.ts
â”‚   â”œâ”€â”€ schemas/                   # Zod Schema
â”‚   â”‚   â”œâ”€â”€ auth.schema.ts
â”‚   â”‚   â”œâ”€â”€ chat.schema.ts
â”‚   â”‚   â””â”€â”€ trip.schema.ts
â”‚   â”œâ”€â”€ types/                     # TypeScript ç±»å‹
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ utils/                     # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ jwt.ts
â”‚   â”‚   â”œâ”€â”€ logger.ts
â”‚   â”‚   â””â”€â”€ response.ts
â”‚   â”œâ”€â”€ docs/                      # API æ–‡æ¡£
â”‚   â”‚   â””â”€â”€ swagger.ts
â”‚   â””â”€â”€ app.ts                     # åº”ç”¨å…¥å£
â”œâ”€â”€ .env                           # ç¯å¢ƒå˜é‡
â”œâ”€â”€ .env.example
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ README.md
```

### 6.1 æ ¸å¿ƒé…ç½®æ–‡ä»¶

```typescript
// src/config/index.ts
import { z } from "zod";
import dotenv from "dotenv";

dotenv.config();

const envSchema = z.object({
  NODE_ENV: z.enum(["development", "production", "test"]).default("development"),
  PORT: z.string().default("3000"),
  DATABASE_URL: z.string(),
  REDIS_URL: z.string().optional(),
  
  JWT_SECRET: z.string(),
  JWT_ACCESS_EXPIRES: z.string().default("15m"),
  JWT_REFRESH_EXPIRES: z.string().default("7d"),
  
  OPENAI_API_KEY: z.string(),
  OPENAI_BASE_URL: z.string().optional(),
  OPENAI_MODEL: z.string().default("gpt-4o"),
  
  AMAP_API_KEY: z.string(),
});

const env = envSchema.parse(process.env);

export const config = {
  env: env.NODE_ENV,
  port: parseInt(env.PORT, 10),
  
  database: {
    url: env.DATABASE_URL,
  },
  
  redis: {
    url: env.REDIS_URL,
  },
  
  jwt: {
    secret: env.JWT_SECRET,
    accessExpiresIn: env.JWT_ACCESS_EXPIRES,
    refreshExpiresIn: env.JWT_REFRESH_EXPIRES,
  },
  
  openai: {
    apiKey: env.OPENAI_API_KEY,
    baseUrl: env.OPENAI_BASE_URL,
    model: env.OPENAI_MODEL,
  },
  
  amap: {
    apiKey: env.AMAP_API_KEY,
  },
};
```

### 6.2 åº”ç”¨å…¥å£

```typescript
// src/app.ts
import express from "express";
import cors from "cors";
import helmet from "helmet";
import compression from "compression";

import { config } from "./config";
import { logger } from "./utils/logger";
import { errorMiddleware } from "./middlewares/error.middleware";
import routes from "./routes";
import { setupSwagger } from "./docs/swagger";

const app = express();

// ä¸­é—´ä»¶
app.use(helmet());
app.use(cors());
app.use(compression());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// API æ–‡æ¡£
setupSwagger(app);

// è·¯ç”±
app.use("/api", routes);

// é”™è¯¯å¤„ç†
app.use(errorMiddleware);

// å¯åŠ¨æœåŠ¡å™¨
app.listen(config.port, () => {
  logger.info(`æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ: http://localhost:${config.port}`);
  logger.info(`API æ–‡æ¡£: http://localhost:${config.port}/docs`);
});

export default app;
```

### 6.3 èŠå¤©æ§åˆ¶å™¨ï¼ˆSSE æµå¼ï¼‰

```typescript
// src/controllers/chat.controller.ts
import { Request, Response } from "express";
import { AgentService } from "@/services/agent.service";

const agentService = new AgentService();

export const chatStream = async (req: Request, res: Response) => {
  const { conversationId, message } = req.query;

  if (!conversationId || !message) {
    res.status(400).json({ error: "ç¼ºå°‘å¿…è¦å‚æ•°" });
    return;
  }

  // è®¾ç½® SSE å“åº”å¤´
  res.setHeader("Content-Type", "text/event-stream");
  res.setHeader("Cache-Control", "no-cache");
  res.setHeader("Connection", "keep-alive");
  res.setHeader("X-Accel-Buffering", "no");

  try {
    const stream = agentService.chat(
      conversationId as string,
      message as string
    );

    for await (const event of stream) {
      const data = JSON.stringify(event.data);
      res.write(`event: ${event.type}\n`);
      res.write(`data: ${data}\n\n`);
    }

    res.write("event: done\n");
    res.write("data: {}\n\n");
    res.end();
  } catch (error) {
    console.error("Chat stream error:", error);
    res.write(`event: error\n`);
    res.write(`data: ${JSON.stringify({ error: "å¤„ç†å¤±è´¥" })}\n\n`);
    res.end();
  }
};
```

---

## ä¸ƒã€å‰ç«¯é¡¹ç›®ç»“æ„

```
travel-planner-frontend/
â”œâ”€â”€ public/
â”‚   â””â”€â”€ favicon.ico
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ api/                       # API è¯·æ±‚
â”‚   â”‚   â”œâ”€â”€ auth.api.ts
â”‚   â”‚   â”œâ”€â”€ chat.api.ts
â”‚   â”‚   â”œâ”€â”€ conversation.api.ts
â”‚   â”‚   â”œâ”€â”€ trip.api.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ assets/                    # é™æ€èµ„æº
â”‚   â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â””â”€â”€ styles/
â”‚   â”‚       â””â”€â”€ global.less
â”‚   â”œâ”€â”€ components/                # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ChatMessage/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â””â”€â”€ index.module.less
â”‚   â”‚   â”œâ”€â”€ ToolCallCard/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â””â”€â”€ index.module.less
â”‚   â”‚   â”œâ”€â”€ TripCard/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â””â”€â”€ index.module.less
â”‚   â”‚   â”œâ”€â”€ TripTimeline/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â””â”€â”€ index.module.less
â”‚   â”‚   â””â”€â”€ Layout/
â”‚   â”‚       â”œâ”€â”€ index.tsx
â”‚   â”‚       â””â”€â”€ index.module.less
â”‚   â”œâ”€â”€ hooks/                     # è‡ªå®šä¹‰ Hooks
â”‚   â”‚   â”œâ”€â”€ useChat.ts
â”‚   â”‚   â”œâ”€â”€ useTrip.ts
â”‚   â”‚   â””â”€â”€ useAuth.ts
â”‚   â”œâ”€â”€ pages/                     # é¡µé¢ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ Chat/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â””â”€â”€ index.module.less
â”‚   â”‚   â”œâ”€â”€ Trip/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ TripDetail.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ TripEdit.tsx
â”‚   â”‚   â”‚   â””â”€â”€ index.module.less
â”‚   â”‚   â”œâ”€â”€ History/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â””â”€â”€ index.module.less
â”‚   â”‚   â”œâ”€â”€ Login/
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx
â”‚   â”‚   â”‚   â””â”€â”€ index.module.less
â”‚   â”‚   â””â”€â”€ Register/
â”‚   â”‚       â”œâ”€â”€ index.tsx
â”‚   â”‚       â””â”€â”€ index.module.less
â”‚   â”œâ”€â”€ stores/                    # Zustand çŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ auth.store.ts
â”‚   â”‚   â”œâ”€â”€ chat.store.ts
â”‚   â”‚   â”œâ”€â”€ trip.store.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”œâ”€â”€ types/                     # TypeScript ç±»å‹
â”‚   â”‚   â”œâ”€â”€ api.types.ts
â”‚   â”‚   â”œâ”€â”€ chat.types.ts
â”‚   â”‚   â””â”€â”€ trip.types.ts
â”‚   â”œâ”€â”€ utils/                     # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ request.ts
â”‚   â”‚   â”œâ”€â”€ storage.ts
â”‚   â”‚   â””â”€â”€ date.ts
â”‚   â”œâ”€â”€ router/                    # è·¯ç”±é…ç½®
â”‚   â”‚   â””â”€â”€ index.tsx
â”‚   â”œâ”€â”€ App.tsx
â”‚   â”œâ”€â”€ main.tsx
â”‚   â””â”€â”€ vite-env.d.ts
â”œâ”€â”€ .eslintrc.js
â”œâ”€â”€ .prettierrc
â”œâ”€â”€ .stylelintrc.js
â”œâ”€â”€ index.html
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tsconfig.node.json
â””â”€â”€ vite.config.ts
```

### 7.1 Zustand Store

```typescript
// src/stores/chat.store.ts
import { create } from "zustand";
import { immer } from "zustand/middleware/immer";

interface Message {
  id: string;
  role: "user" | "assistant" | "tool";
  content: string;
  toolCalls?: Array<{
    id: string;
    name: string;
    arguments: Record<string, unknown>;
    result?: unknown;
    status: "pending" | "running" | "completed" | "error";
  }>;
  createdAt: string;
}

interface ChatState {
  conversations: Array<{
    id: string;
    title: string;
    messages: Message[];
  }>;
  currentConversationId: string | null;
  isLoading: boolean;
  streamingContent: string;
  currentToolCall: {
    id: string;
    name: string;
    arguments: string;
    status: string;
  } | null;
  
  // Actions
  setCurrentConversation: (id: string | null) => void;
  addMessage: (conversationId: string, message: Message) => void;
  updateStreamingContent: (content: string) => void;
  appendStreamingContent: (delta: string) => void;
  setToolCall: (toolCall: ChatState["currentToolCall"]) => void;
  updateToolCallResult: (toolCallId: string, result: unknown) => void;
  clearStreaming: () => void;
  setLoading: (loading: boolean) => void;
}

export const useChatStore = create<ChatState>()(
  immer((set) => ({
    conversations: [],
    currentConversationId: null,
    isLoading: false,
    streamingContent: "",
    currentToolCall: null,

    setCurrentConversation: (id) =>
      set((state) => {
        state.currentConversationId = id;
      }),

    addMessage: (conversationId, message) =>
      set((state) => {
        const conversation = state.conversations.find(
          (c) => c.id === conversationId
        );
        if (conversation) {
          conversation.messages.push(message);
        }
      }),

    updateStreamingContent: (content) =>
      set((state) => {
        state.streamingContent = content;
      }),

    appendStreamingContent: (delta) =>
      set((state) => {
        state.streamingContent += delta;
      }),

    setToolCall: (toolCall) =>
      set((state) => {
        state.currentToolCall = toolCall;
      }),

    updateToolCallResult: (toolCallId, result) =>
      set((state) => {
        if (state.currentToolCall?.id === toolCallId) {
          state.currentToolCall.status = "completed";
        }
      }),

    clearStreaming: () =>
      set((state) => {
        state.streamingContent = "";
        state.currentToolCall = null;
      }),

    setLoading: (loading) =>
      set((state) => {
        state.isLoading = loading;
      }),
  }))
);
```

### 7.2 èŠå¤© Hookï¼ˆSSE å¤„ç†ï¼‰

```typescript
// src/hooks/useChat.ts
import { useCallback, useRef } from "react";
import { useChatStore } from "@/stores/chat.store";
import { useTripStore } from "@/stores/trip.store";
import { API_BASE_URL } from "@/api";

export function useChat() {
  const {
    currentConversationId,
    isLoading,
    streamingContent,
    currentToolCall,
    setLoading,
    addMessage,
    appendStreamingContent,
    setToolCall,
    updateToolCallResult,
    clearStreaming,
  } = useChatStore();

  const { setCurrentTrip } = useTripStore();
  const abortControllerRef = useRef<AbortController | null>(null);

  const sendMessage = useCallback(
    async (message: string) => {
      if (!currentConversationId || isLoading) return;

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addMessage(currentConversationId, {
        id: `user_${Date.now()}`,
        role: "user",
        content: message,
        createdAt: new Date().toISOString(),
      });

      setLoading(true);
      clearStreaming();

      // åˆ›å»º AbortController
      abortControllerRef.current = new AbortController();

      try {
        const url = new URL(`${API_BASE_URL}/chat/stream`);
        url.searchParams.set("conversationId", currentConversationId);
        url.searchParams.set("message", message);

        const response = await fetch(url.toString(), {
          method: "GET",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("accessToken")}`,
          },
          signal: abortControllerRef.current.signal,
        });

        if (!response.ok) {
          throw new Error("è¯·æ±‚å¤±è´¥");
        }

        const reader = response.body?.getReader();
        const decoder = new TextDecoder();

        if (!reader) {
          throw new Error("æ— æ³•è¯»å–å“åº”æµ");
        }

        let buffer = "";
        let assistantMessageId = `assistant_${Date.now()}`;
        let fullContent = "";

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });

          // è§£æ SSE äº‹ä»¶
          const lines = buffer.split("\n");
          buffer = lines.pop() || "";

          let eventType = "";
          for (const line of lines) {
            if (line.startsWith("event: ")) {
              eventType = line.slice(7);
            } else if (line.startsWith("data: ")) {
              const data = JSON.parse(line.slice(6));
              
              switch (eventType) {
                case "content_delta":
                  fullContent += data.content || "";
                  appendStreamingContent(data.content || "");
                  break;
                  
                case "tool_call":
                  setToolCall({
                    id: data.id,
                    name: data.name,
                    arguments: JSON.stringify(data.arguments, null, 2),
                    status: "running",
                  });
                  break;
                  
                case "tool_result":
                  updateToolCallResult(data.toolCallId, data.result);
                  break;
                  
                case "trip_generated":
                  setCurrentTrip(data.trip);
                  break;
                  
                case "message_end":
                  // æ·»åŠ å®Œæ•´çš„ AI æ¶ˆæ¯
                  addMessage(currentConversationId, {
                    id: assistantMessageId,
                    role: "assistant",
                    content: fullContent,
                    createdAt: new Date().toISOString(),
                  });
                  break;
                  
                case "error":
                  console.error("Stream error:", data.error);
                  break;
              }
            }
          }
        }
      } catch (error) {
        if ((error as Error).name !== "AbortError") {
          console.error("Chat error:", error);
        }
      } finally {
        setLoading(false);
        clearStreaming();
        abortControllerRef.current = null;
      }
    },
    [currentConversationId, isLoading]
  );

  const stopGeneration = useCallback(() => {
    if (abortControllerRef.current) {
      abortControllerRef.current.abort();
    }
  }, []);

  return {
    sendMessage,
    stopGeneration,
    isLoading,
    streamingContent,
    currentToolCall,
  };
}
```

### 7.3 èŠå¤©é¡µé¢

```tsx
// src/pages/Chat/index.tsx
import React, { useState, useRef, useEffect } from "react";
import { Input, Button, Spin, Card } from "antd";
import { SendOutlined, StopOutlined } from "@ant-design/icons";
import { useChat } from "@/hooks/useChat";
import { useChatStore } from "@/stores/chat.store";
import { useTripStore } from "@/stores/trip.store";
import ChatMessage from "@/components/ChatMessage";
import ToolCallCard from "@/components/ToolCallCard";
import TripCard from "@/components/TripCard";
import styles from "./index.module.less";

const ChatPage: React.FC = () => {
  const [inputValue, setInputValue] = useState("");
  const messagesEndRef = useRef<HTMLDivElement>(null);
  
  const { conversations, currentConversationId, streamingContent, currentToolCall } = useChatStore();
  const { currentTrip } = useTripStore();
  const { sendMessage, stopGeneration, isLoading } = useChat();

  const currentConversation = conversations.find(
    (c) => c.id === currentConversationId
  );

  const handleSend = () => {
    if (!inputValue.trim() || isLoading) return;
    sendMessage(inputValue.trim());
    setInputValue("");
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [currentConversation?.messages, streamingContent]);

  return (
    <div className={styles.chatPage}>
      <div className={styles.messageList}>
        {/* æ¬¢è¿æ¶ˆæ¯ */}
        {!currentConversation?.messages.length && (
          <div className={styles.welcome}>
            <h2>ğŸŒ´ æ¬¢è¿ä½¿ç”¨ AI æ—…æ¸¸è§„åˆ’å¸ˆ</h2>
            <p>å‘Šè¯‰æˆ‘ä½ æƒ³å»å“ªé‡Œï¼Œæˆ‘æ¥å¸®ä½ è§„åˆ’å®Œç¾çš„æ—…è¡Œï¼</p>
            <div className={styles.examples}>
              <Card 
                size="small" 
                hoverable
                onClick={() => setInputValue("æˆ‘æƒ³å»æ­å·ç©3å¤©ï¼Œé¢„ç®—3000")}
              >
                ğŸï¸ æˆ‘æƒ³å»æ­å·ç©3å¤©ï¼Œé¢„ç®—3000
              </Card>
              <Card 
                size="small"
                hoverable
                onClick={() => setInputValue("ä¸‹å‘¨æœ«æƒ³å»ä¸Šæµ·è¿ªå£«å°¼ï¼Œä¸¤ä¸ªäºº")}
              >
                ğŸ¢ ä¸‹å‘¨æœ«æƒ³å»ä¸Šæµ·è¿ªå£«å°¼ï¼Œä¸¤ä¸ªäºº
              </Card>
              <Card 
                size="small"
                hoverable
                onClick={() => setInputValue("å¸®æˆ‘è§„åˆ’ä¸€ä¸ªåŒ—äº¬5æ—¥æ¸¸ï¼Œæƒ³çœ‹æ•…å®«é•¿åŸ")}
              >
                ğŸ›ï¸ å¸®æˆ‘è§„åˆ’ä¸€ä¸ªåŒ—äº¬5æ—¥æ¸¸
              </Card>
            </div>
          </div>
        )}

        {/* æ¶ˆæ¯åˆ—è¡¨ */}
        {currentConversation?.messages.map((message) => (
          <ChatMessage key={message.id} message={message} />
        ))}

        {/* æµå¼å†…å®¹ */}
        {streamingContent && (
          <ChatMessage
            message={{
              id: "streaming",
              role: "assistant",
              content: streamingContent,
              createdAt: new Date().toISOString(),
            }}
            isStreaming
          />
        )}

        {/* å·¥å…·è°ƒç”¨å¡ç‰‡ */}
        {currentToolCall && (
          <ToolCallCard toolCall={currentToolCall} />
        )}

        {/* ç”Ÿæˆçš„è¡Œç¨‹å¡ç‰‡ */}
        {currentTrip && (
          <TripCard trip={currentTrip} />
        )}

        <div ref={messagesEndRef} />
      </div>

      {/* è¾“å…¥åŒºåŸŸ */}
      <div className={styles.inputArea}>
        <Input.TextArea
          value={inputValue}
          onChange={(e) => setInputValue(e.target.value)}
          onKeyDown={handleKeyDown}
          placeholder="å‘Šè¯‰æˆ‘ä½ çš„æ—…è¡Œè®¡åˆ’..."
          autoSize={{ minRows: 1, maxRows: 4 }}
          disabled={isLoading}
        />
        {isLoading ? (
          <Button
            type="primary"
            danger
            icon={<StopOutlined />}
            onClick={stopGeneration}
          >
            åœæ­¢
          </Button>
        ) : (
          <Button
            type="primary"
            icon={<SendOutlined />}
            onClick={handleSend}
            disabled={!inputValue.trim()}
          >
            å‘é€
          </Button>
        )}
      </div>
    </div>
  );
};

export default ChatPage;
```

### 7.4 å·¥å…·è°ƒç”¨å¡ç‰‡ç»„ä»¶

```tsx
// src/components/ToolCallCard/index.tsx
import React from "react";
import { Card, Spin, Tag } from "antd";
import {
  CloudOutlined,
  TrainOutlined,
  HomeOutlined,
  EnvironmentOutlined,
  CalendarOutlined,
  FileTextOutlined,
} from "@ant-design/icons";
import styles from "./index.module.less";

interface ToolCallCardProps {
  toolCall: {
    id: string;
    name: string;
    arguments: string;
    status: string;
  };
}

const toolConfig: Record<string, { icon: React.ReactNode; label: string; color: string }> = {
  get_weather: {
    icon: <CloudOutlined />,
    label: "æŸ¥è¯¢å¤©æ°”",
    color: "#1890ff",
  },
  search_train: {
    icon: <TrainOutlined />,
    label: "æœç´¢ç«è½¦ç¥¨",
    color: "#52c41a",
  },
  search_hotel: {
    icon: <HomeOutlined />,
    label: "æœç´¢é…’åº—",
    color: "#faad14",
  },
  search_poi: {
    icon: <EnvironmentOutlined />,
    label: "æœç´¢æ™¯ç‚¹",
    color: "#eb2f96",
  },
  get_current_date: {
    icon: <CalendarOutlined />,
    label: "è·å–æ—¥æœŸ",
    color: "#722ed1",
  },
  generate_trip: {
    icon: <FileTextOutlined />,
    label: "ç”Ÿæˆè¡Œç¨‹",
    color: "#13c2c2",
  },
};

const ToolCallCard: React.FC<ToolCallCardProps> = ({ toolCall }) => {
  const config = toolConfig[toolCall.name] || {
    icon: <FileTextOutlined />,
    label: toolCall.name,
    color: "#666",
  };

  const isRunning = toolCall.status === "running";

  return (
    <Card className={styles.toolCallCard} size="small">
      <div className={styles.header}>
        <span className={styles.icon} style={{ color: config.color }}>
          {config.icon}
        </span>
        <span className={styles.label}>{config.label}</span>
        {isRunning ? (
          <Spin size="small" />
        ) : (
          <Tag color="success">å®Œæˆ</Tag>
        )}
      </div>
      {toolCall.arguments && (
        <pre className={styles.arguments}>
          {toolCall.arguments}
        </pre>
      )}
    </Card>
  );
};

export default ToolCallCard;
```

### 7.5 è¡Œç¨‹å¡ç‰‡ç»„ä»¶

```tsx
// src/components/TripCard/index.tsx
import React from "react";
import { Card, Button, Tag, Timeline, Tooltip } from "antd";
import {
  CalendarOutlined,
  EnvironmentOutlined,
  DollarOutlined,
  EditOutlined,
  CheckOutlined,
} from "@ant-design/icons";
import { useNavigate } from "react-router-dom";
import type { Trip } from "@/types/trip.types";
import styles from "./index.module.less";

interface TripCardProps {
  trip: Trip;
}

const activityTypeConfig: Record<string, { color: string; label: string }> = {
  attraction: { color: "#1890ff", label: "æ™¯ç‚¹" },
  restaurant: { color: "#fa8c16", label: "é¤å…" },
  transport: { color: "#52c41a", label: "äº¤é€š" },
  hotel: { color: "#722ed1", label: "ä½å®¿" },
  free: { color: "#bfbfbf", label: "è‡ªç”±" },
};

const TripCard: React.FC<TripCardProps> = ({ trip }) => {
  const navigate = useNavigate();

  return (
    <Card className={styles.tripCard}>
      <div className={styles.header}>
        <h3>{trip.title}</h3>
        <Tag color={trip.status === "confirmed" ? "success" : "default"}>
          {trip.status === "confirmed" ? "å·²ç¡®è®¤" : "è‰ç¨¿"}
        </Tag>
      </div>

      <div className={styles.meta}>
        <span>
          <EnvironmentOutlined /> {trip.destination}
        </span>
        <span>
          <CalendarOutlined /> {trip.startDate} - {trip.endDate}
        </span>
        <span>
          <DollarOutlined /> é¢„ç®— Â¥{trip.budget}
        </span>
      </div>

      <div className={styles.days}>
        {trip.days.map((day) => (
          <div key={day.id} className={styles.day}>
            <div className={styles.dayHeader}>
              <span className={styles.dayNumber}>Day {day.dayNumber}</span>
              <span className={styles.dayDate}>{day.date}</span>
            </div>
            <Timeline
              className={styles.timeline}
              items={day.activities.map((activity) => ({
                color: activityTypeConfig[activity.type]?.color || "#1890ff",
                children: (
                  <div className={styles.activity}>
                    <span className={styles.time}>
                      {activity.startTime} - {activity.endTime}
                    </span>
                    <span className={styles.name}>{activity.name}</span>
                    {activity.cost > 0 && (
                      <Tag size="small">Â¥{activity.cost}</Tag>
                    )}
                  </div>
                ),
              }))}
            />
          </div>
        ))}
      </div>

      <div className={styles.actions}>
        <Button
          icon={<EditOutlined />}
          onClick={() => navigate(`/trip/${trip.id}/edit`)}
        >
          ç¼–è¾‘è¡Œç¨‹
        </Button>
        {trip.status === "draft" && (
          <Button
            type="primary"
            icon={<CheckOutlined />}
            onClick={() => {/* ç¡®è®¤è¡Œç¨‹ */}}
          >
            ç¡®è®¤è¡Œç¨‹
          </Button>
        )}
      </div>
    </Card>
  );
};

export default TripCard;
```

---

## å…«ã€è¡Œç¨‹ç¼–è¾‘é¡µé¢

### 8.1 å¯æ‹–æ‹½è¡Œç¨‹ç¼–è¾‘

```tsx
// src/pages/Trip/TripEdit.tsx
import React, { useState, useEffect } from "react";
import { useParams, useNavigate } from "react-router-dom";
import {
  Card,
  Button,
  Input,
  DatePicker,
  InputNumber,
  message,
  Spin,
  Modal,
} from "antd";
import {
  DragDropContext,
  Droppable,
  Draggable,
  DropResult,
} from "@hello-pangea/dnd";
import {
  PlusOutlined,
  DeleteOutlined,
  SaveOutlined,
  ArrowLeftOutlined,
} from "@ant-design/icons";
import dayjs from "dayjs";
import { tripApi } from "@/api/trip.api";
import type { Trip, TripDay, TripActivity } from "@/types/trip.types";
import ActivityModal from "./components/ActivityModal";
import styles from "./index.module.less";

const TripEdit: React.FC = () => {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  
  const [trip, setTrip] = useState<Trip | null>(null);
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [activityModal, setActivityModal] = useState<{
    visible: boolean;
    dayId: string;
    activity?: TripActivity;
  }>({ visible: false, dayId: "" });

  useEffect(() => {
    loadTrip();
  }, [id]);

  const loadTrip = async () => {
    if (!id) return;
    try {
      const data = await tripApi.getTrip(id);
      setTrip(data);
    } catch (error) {
      message.error("åŠ è½½è¡Œç¨‹å¤±è´¥");
    } finally {
      setLoading(false);
    }
  };

  const handleDragEnd = (result: DropResult) => {
    if (!result.destination || !trip) return;

    const { source, destination, type } = result;

    if (type === "day") {
      // æ‹–æ‹½å¤©
      const newDays = Array.from(trip.days);
      const [removed] = newDays.splice(source.index, 1);
      newDays.splice(destination.index, 0, removed);
      
      // æ›´æ–° dayNumber
      newDays.forEach((day, index) => {
        day.dayNumber = index + 1;
      });
      
      setTrip({ ...trip, days: newDays });
    } else if (type === "activity") {
      // æ‹–æ‹½æ´»åŠ¨
      const sourceDayIndex = trip.days.findIndex(
        (d) => d.id === source.droppableId
      );
      const destDayIndex = trip.days.findIndex(
        (d) => d.id === destination.droppableId
      );

      if (sourceDayIndex === -1 || destDayIndex === -1) return;

      const newDays = Array.from(trip.days);

      if (sourceDayIndex === destDayIndex) {
        // åŒä¸€å¤©å†…æ‹–æ‹½
        const activities = Array.from(newDays[sourceDayIndex].activities);
        const [removed] = activities.splice(source.index, 1);
        activities.splice(destination.index, 0, removed);
        
        // æ›´æ–°é¡ºåº
        activities.forEach((act, index) => {
          act.order = index;
        });
        
        newDays[sourceDayIndex].activities = activities;
      } else {
        // è·¨å¤©æ‹–æ‹½
        const sourceActivities = Array.from(newDays[sourceDayIndex].activities);
        const destActivities = Array.from(newDays[destDayIndex].activities);
        const [removed] = sourceActivities.splice(source.index, 1);
        destActivities.splice(destination.index, 0, removed);
        
        // æ›´æ–°é¡ºåº
        sourceActivities.forEach((act, index) => {
          act.order = index;
        });
        destActivities.forEach((act, index) => {
          act.order = index;
        });
        
        newDays[sourceDayIndex].activities = sourceActivities;
        newDays[destDayIndex].activities = destActivities;
      }

      setTrip({ ...trip, days: newDays });
    }
  };

  const handleSave = async () => {
    if (!trip) return;
    
    setSaving(true);
    try {
      await tripApi.updateTrip(trip.id, {
        title: trip.title,
        startDate: trip.startDate,
        endDate: trip.endDate,
        budget: trip.budget,
        days: trip.days.map((day) => ({
          id: day.id,
          dayNumber: day.dayNumber,
          date: day.date,
          activities: day.activities.map((act) => ({
            id: act.id,
            type: act.type,
            name: act.name,
            location: act.location,
            startTime: act.startTime,
            endTime: act.endTime,
            duration: act.duration,
            cost: act.cost,
            notes: act.notes,
            order: act.order,
            poiId: act.poiId,
          })),
        })),
      });
      message.success("ä¿å­˜æˆåŠŸ");
    } catch (error) {
      message.error("ä¿å­˜å¤±è´¥");
    } finally {
      setSaving(false);
    }
  };

  const handleAddActivity = (dayId: string) => {
    setActivityModal({ visible: true, dayId });
  };

  const handleEditActivity = (dayId: string, activity: TripActivity) => {
    setActivityModal({ visible: true, dayId, activity });
  };

  const handleDeleteActivity = (dayId: string, activityId: string) => {
    if (!trip) return;
    
    Modal.confirm({
      title: "ç¡®è®¤åˆ é™¤",
      content: "ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ´»åŠ¨å—ï¼Ÿ",
      onOk: () => {
        const newDays = trip.days.map((day) => {
          if (day.id === dayId) {
            return {
              ...day,
              activities: day.activities.filter((a) => a.id !== activityId),
            };
          }
          return day;
        });
        setTrip({ ...trip, days: newDays });
      },
    });
  };

  const handleActivitySave = (dayId: string, activity: TripActivity) => {
    if (!trip) return;

    const newDays = trip.days.map((day) => {
      if (day.id === dayId) {
        const existingIndex = day.activities.findIndex((a) => a.id === activity.id);
        if (existingIndex > -1) {
          // ç¼–è¾‘
          const newActivities = [...day.activities];
          newActivities[existingIndex] = activity;
          return { ...day, activities: newActivities };
        } else {
          // æ–°å¢
          return {
            ...day,
            activities: [...day.activities, { ...activity, order: day.activities.length }],
          };
        }
      }
      return day;
    });

    setTrip({ ...trip, days: newDays });
    setActivityModal({ visible: false, dayId: "" });
  };

  if (loading) {
    return (
      <div className={styles.loading}>
        <Spin size="large" />
      </div>
    );
  }

  if (!trip) {
    return <div>è¡Œç¨‹ä¸å­˜åœ¨</div>;
  }

  return (
    <div className={styles.tripEdit}>
      <div className={styles.header}>
        <Button
          icon={<ArrowLeftOutlined />}
          onClick={() => navigate(-1)}
        >
          è¿”å›
        </Button>
        <h2>ç¼–è¾‘è¡Œç¨‹</h2>
        <Button
          type="primary"
          icon={<SaveOutlined />}
          loading={saving}
          onClick={handleSave}
        >
          ä¿å­˜
        </Button>
      </div>

      <Card className={styles.basicInfo}>
        <div className={styles.formRow}>
          <label>è¡Œç¨‹æ ‡é¢˜</label>
          <Input
            value={trip.title}
            onChange={(e) => setTrip({ ...trip, title: e.target.value })}
          />
        </div>
        <div className={styles.formRow}>
          <label>å‡ºè¡Œæ—¥æœŸ</label>
          <DatePicker.RangePicker
            value={[dayjs(trip.startDate), dayjs(trip.endDate)]}
            onChange={(dates) => {
              if (dates) {
                setTrip({
                  ...trip,
                  startDate: dates[0]!.format("YYYY-MM-DD"),
                  endDate: dates[1]!.format("YYYY-MM-DD"),
                });
              }
            }}
          />
        </div>
        <div className={styles.formRow}>
          <label>é¢„ç®—</label>
          <InputNumber
            value={trip.budget}
            onChange={(value) => setTrip({ ...trip, budget: value || 0 })}
            prefix="Â¥"
            min={0}
          />
        </div>
      </Card>

      <DragDropContext onDragEnd={handleDragEnd}>
        <Droppable droppableId="days" type="day">
          {(provided) => (
            <div
              ref={provided.innerRef}
              {...provided.droppableProps}
              className={styles.days}
            >
              {trip.days.map((day, dayIndex) => (
                <Draggable key={day.id} draggableId={day.id} index={dayIndex}>
                  {(provided) => (
                    <Card
                      ref={provided.innerRef}
                      {...provided.draggableProps}
                      className={styles.dayCard}
                    >
                      <div
                        className={styles.dayHeader}
                        {...provided.dragHandleProps}
                      >
                        <span className={styles.dayNumber}>
                          Day {day.dayNumber}
                        </span>
                        <span className={styles.dayDate}>{day.date}</span>
                      </div>

                      <Droppable droppableId={day.id} type="activity">
                        {(provided) => (
                          <div
                            ref={provided.innerRef}
                            {...provided.droppableProps}
                            className={styles.activities}
                          >
                            {day.activities.map((activity, actIndex) => (
                              <Draggable
                                key={activity.id}
                                draggableId={activity.id}
                                index={actIndex}
                              >
                                {(provided) => (
                                  <div
                                    ref={provided.innerRef}
                                    {...provided.draggableProps}
                                    {...provided.dragHandleProps}
                                    className={styles.activityItem}
                                  >
                                    <span className={styles.time}>
                                      {activity.startTime} - {activity.endTime}
                                    </span>
                                    <span className={styles.name}>
                                      {activity.name}
                                    </span>
                                    <div className={styles.actions}>
                                      <Button
                                        type="link"
                                        size="small"
                                        onClick={() =>
                                          handleEditActivity(day.id, activity)
                                        }
                                      >
                                        ç¼–è¾‘
                                      </Button>
                                      <Button
                                        type="link"
                                        size="small"
                                        danger
                                        icon={<DeleteOutlined />}
                                        onClick={() =>
                                          handleDeleteActivity(day.id, activity.id)
                                        }
                                      />
                                    </div>
                                  </div>
                                )}
                              </Draggable>
                            ))}
                            {provided.placeholder}
                          </div>
                        )}
                      </Droppable>

                      <Button
                        type="dashed"
                        icon={<PlusOutlined />}
                        className={styles.addActivity}
                        onClick={() => handleAddActivity(day.id)}
                      >
                        æ·»åŠ æ´»åŠ¨
                      </Button>
                    </Card>
                  )}
                </Draggable>
              ))}
              {provided.placeholder}
            </div>
          )}
        </Droppable>
      </DragDropContext>

      <ActivityModal
        visible={activityModal.visible}
        dayId={activityModal.dayId}
        activity={activityModal.activity}
        onSave={handleActivitySave}
        onCancel={() => setActivityModal({ visible: false, dayId: "" })}
      />
    </div>
  );
};

export default TripEdit;
```

---

## ä¹ã€ç¯å¢ƒå˜é‡é…ç½®

### 9.1 åç«¯ç¯å¢ƒå˜é‡

```bash
# .env.example

# æœåŠ¡å™¨é…ç½®
NODE_ENV=development
PORT=3000

# æ•°æ®åº“é…ç½®
DATABASE_URL="mysql://root:password@localhost:3306/travel_planner"

# Redis é…ç½®ï¼ˆå¯é€‰ï¼‰
REDIS_URL="redis://localhost:6379"

# JWT é…ç½®
JWT_SECRET="your-super-secret-jwt-key-change-in-production"
JWT_ACCESS_EXPIRES="15m"
JWT_REFRESH_EXPIRES="7d"

# OpenAI é…ç½®
OPENAI_API_KEY="sk-your-openai-api-key"
OPENAI_BASE_URL="https://api.openai.com/v1"
OPENAI_MODEL="gpt-4o"

# é«˜å¾·åœ°å›¾ API
AMAP_API_KEY="your-amap-api-key"
```

### 9.2 å‰ç«¯ç¯å¢ƒå˜é‡

```bash
# .env.development
VITE_API_BASE_URL=http://localhost:3000/api

# .env.production
VITE_API_BASE_URL=https://your-domain.com/api
```

---

## åã€éƒ¨ç½²è¯´æ˜

### 10.1 Docker Compose

```yaml
# docker-compose.yml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: travel-planner-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: travel_planner
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:7-alpine
    container_name: travel-planner-redis
    ports:
      - "6379:6379"

  backend:
    build:
      context: ./travel-planner-backend
      dockerfile: Dockerfile
    container_name: travel-planner-backend
    environment:
      - NODE_ENV=production
      - DATABASE_URL=mysql://root:rootpassword@mysql:3306/travel_planner
      - REDIS_URL=redis://redis:6379
    ports:
      - "3000:3000"
    depends_on:
      - mysql
      - redis

  frontend:
    build:
      context: ./travel-planner-frontend
      dockerfile: Dockerfile
    container_name: travel-planner-frontend
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  mysql_data:
```

### 10.2 åç«¯ Dockerfile

```dockerfile
# travel-planner-backend/Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
COPY prisma ./prisma/

RUN npm ci

COPY . .

RUN npm run build
RUN npx prisma generate

FROM node:20-alpine AS runner

WORKDIR /app

COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/prisma ./prisma
COPY --from=builder /app/package*.json ./

EXPOSE 3000

CMD ["npm", "run", "start:prod"]
```

### 10.3 å‰ç«¯ Dockerfile

```dockerfile
# travel-planner-frontend/Dockerfile
FROM node:20-alpine AS builder

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM nginx:alpine

COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

---

## åä¸€ã€æ€»ç»“

### æŠ€æœ¯è¦ç‚¹å›é¡¾

| æ¨¡å— | æŠ€æœ¯æ ˆ | è¯´æ˜ |
|------|-------|------|
| **Multi-Agent** | LangGraph StateGraph | Router + Sub-Agent æ··åˆæ¶æ„ |
| **Coordinator** | withStructuredOutput | æ„å›¾è¯†åˆ« + å‚æ•°æå– + è·¯ç”± |
| **Info Collector** | createReactAgent | 8 ä¸ªå·¥å…·å¹¶è¡Œä¿¡æ¯æ”¶é›† |
| **Trip Planner** | withStructuredOutput | ç»“æ„åŒ–è¡Œç¨‹ç”Ÿæˆ |
| **Trip Adjuster** | createReactAgent | è¡Œç¨‹ä¿®æ”¹ + å†²çªè§£å†³ |
| **å·¥å…·è°ƒç”¨** | @langchain/core/tools | å¤©æ°”ã€äº¤é€šã€é…’åº—ã€æ™¯ç‚¹ã€é¤å…ã€è·¯çº¿ã€æ—¥æœŸã€POI |
| **æµå¼è¾“å‡º** | SSE | å®æ—¶å±•ç¤º AI æ€è€ƒè¿‡ç¨‹å’Œå·¥å…·è°ƒç”¨ |
| **å¤–éƒ¨API** | é«˜å¾·åœ°å›¾ + 12306 | å¤©æ°”ã€POIã€è·¯çº¿è§„åˆ’ã€ç«è½¦ç¥¨ |
| **ç¼“å­˜é™çº§** | Redis + å†…å­˜ | Redis ä¸å¯ç”¨æ—¶è‡ªåŠ¨é™çº§ |
| **å‰ç«¯çŠ¶æ€** | Zustand | ç®€æ´çš„çŠ¶æ€ç®¡ç† |
| **æ‹–æ‹½ç¼–è¾‘** | @hello-pangea/dnd | å¯è§†åŒ–è¡Œç¨‹ç¼–è¾‘ |

### æ¶æ„äº®ç‚¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é¡¹ç›®æ¶æ„äº®ç‚¹                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  1. Router + Sub-Agent æ··åˆæ¶æ„                                      â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚     â”‚  Coordinator â”‚ â†’ æ„å›¾è¯†åˆ« â†’ è·¯ç”±åˆ†å‘                           â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚            â–¼              â–¼              â–¼                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚     â”‚Info Collectâ”‚ â”‚Trip Plannerâ”‚ â”‚Trip Adjusterâ”‚                   â”‚
â”‚     â”‚ (å·¥å…·è°ƒç”¨) â”‚ â”‚ (LLMæ¨ç†)  â”‚ â”‚ (å·¥å…·+æ¨ç†)â”‚                    â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                     â”‚
â”‚  2. è¡Œç¨‹ç”Ÿæˆæ˜¯ Agent è€Œé Tool                                       â”‚
â”‚     â€¢ å¤æ‚æ¨ç†ï¼šç»¼åˆå¤©æ°”ã€äº¤é€šã€åœ°ç†ä½ç½®ç­‰å¤šå› ç´                       â”‚
â”‚     â€¢ åˆ›é€ æ€§è¾“å‡ºï¼šå®‰æ’ä¸»é¢˜ã€èŠ‚å¥ã€æƒŠå–œ                               â”‚
â”‚     â€¢ ç»“æ„åŒ–è¾“å‡ºï¼šZod Schema ç¡®ä¿æ•°æ®æ ¼å¼                            â”‚
â”‚                                                                     â”‚
â”‚  3. 8 ä¸ªä¸“ä¸šå·¥å…·å…¨è¦†ç›–                                               â”‚
â”‚     å¤©æ°” + ç«è½¦ç¥¨ + é…’åº— + æ™¯ç‚¹ + é¤å… + è·¯çº¿ + æ—¥æœŸ + POI           â”‚
â”‚                                                                     â”‚
â”‚  4. å¤šå·¥å…·å¹¶è¡Œæå‡æ•ˆç‡                                               â”‚
â”‚     Info Collector åŒæ—¶è°ƒç”¨ 6-7 ä¸ªå·¥å…·ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´                 â”‚
â”‚                                                                     â”‚
â”‚  5. HITL (Human-in-the-Loop)                                        â”‚
â”‚     ç”Ÿæˆè‰ç¨¿ â†’ ç”¨æˆ·ç¼–è¾‘ â†’ ç¡®è®¤ä¿å­˜                                   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é¡¹ç›®äº®ç‚¹

1. **å®Œæ•´çš„ Multi-Agent æ¶æ„**ï¼šCoordinator + 3 ä¸ª Sub-Agent åˆ†å·¥åä½œ
2. **è¡Œç¨‹è§„åˆ’ä¸“ä¸šåŒ–**ï¼šTrip Planner Agent ä¸“æ³¨äºæ™ºèƒ½æ’ç¨‹ï¼Œä¸æ˜¯ç®€å•çš„å·¥å…·è°ƒç”¨
3. **8 ä¸ªå·¥å…·å…¨è¦†ç›–**ï¼šå¤©æ°”ã€äº¤é€šã€é…’åº—ã€æ™¯ç‚¹ã€é¤å…ã€è·¯çº¿è§„åˆ’ä¸€åº”ä¿±å…¨
4. **å¤šå·¥å…·å¹¶è¡Œ**ï¼šInfo Collector åŒæ—¶è°ƒç”¨å¤šä¸ªå·¥å…·ï¼Œå¤§å¹…æå‡å“åº”é€Ÿåº¦
5. **æµå¼ä½“éªŒ**ï¼šå®æ—¶å±•ç¤º AI æ€è€ƒè¿‡ç¨‹ï¼Œç”¨æˆ·ä½“éªŒå¥½
6. **å¯è§†åŒ–ç¼–è¾‘**ï¼šæ‹–æ‹½è°ƒæ•´è¡Œç¨‹ï¼Œæ”¯æŒè·¨å¤©ç§»åŠ¨æ´»åŠ¨
7. **ä¼˜é›…é™çº§**ï¼šRedis ä¸å¯ç”¨æ—¶è‡ªåŠ¨ä½¿ç”¨å†…å­˜ç¼“å­˜
8. **è¡Œç¨‹ä¿®æ”¹æ”¯æŒ**ï¼šTrip Adjuster å¤„ç†ç”¨æˆ·çš„ä¿®æ”¹è¯·æ±‚

### æ‰©å±•æ–¹å‘

- æ¥å…¥æ›´å¤šæ•°æ®æºï¼ˆæœºç¥¨ã€æ™¯ç‚¹é—¨ç¥¨ã€é¤å…é¢„è®¢ï¼‰
- æ·»åŠ åœ°å›¾å¯è§†åŒ–ï¼ˆå±•ç¤ºè¡Œç¨‹è·¯çº¿ã€æ™¯ç‚¹ä½ç½®ï¼‰
- æ”¯æŒå¤šäººåä½œç¼–è¾‘è¡Œç¨‹
- æ·»åŠ è¡Œç¨‹åˆ†äº«å’Œå¯¼å‡ºåŠŸèƒ½ï¼ˆPDFã€æ—¥å†ï¼‰
- æ¥å…¥æ”¯ä»˜ç³»ç»Ÿå®ç°åœ¨çº¿é¢„è®¢
- æ·»åŠ æ™ºèƒ½æ¨èï¼ˆæ ¹æ®å†å²åå¥½ï¼‰
- æ”¯æŒå¤šè¯­è¨€ï¼ˆå›½é™…åŒ–è¡Œç¨‹è§„åˆ’ï¼‰
